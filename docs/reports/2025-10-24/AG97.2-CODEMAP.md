# AG97.2 — CODEMAP

## Modified Files

### frontend/src/app/api/admin/orders/facets/route.ts (lines 1-36)
- **Import added (line 4)**:
  ```typescript
  import { createPgFacetProvider, type FacetQuery } from '../../../../admin/orders/_server/facets.provider';
  ```

- **Env-guarded PG provider wiring (lines 10-36)**:
  ```typescript
  const isDemo = forceDemo || url.searchParams.get('mode') === 'demo';
  const wantPg = process.env.DIXIS_AGG_PROVIDER === 'pg';

  if (wantPg && !isDemo) {
    try {
      const { PrismaClient } = await import('@prisma/client');
      const prisma = new PrismaClient();
      const provider = createPgFacetProvider(() => prisma);

      const q: FacetQuery = {
        status: url.searchParams.get('status') || undefined,
        q: url.searchParams.get('q') || undefined,
        fromDate: url.searchParams.get('fromDate') || undefined,
        toDate: url.searchParams.get('toDate') || undefined,
        sort: url.searchParams.get('sort') || undefined,
      };

      const { totals, total } = await provider.getFacetTotals(q);
      return NextResponse.json({ totals, total, provider: 'pg' }, { status: 200, headers: { 'Cache-Control': 'no-store' } });
    } catch (e) {
      console.warn('AG97.2 fallback to demo:', e);
    }
  }
  ```

## Dependencies
- **AG97.1**: createPgFacetProvider, FacetQuery from facets.provider.ts
- **@prisma/client**: Dynamic import (optional dependency)
- **Existing demo flow**: Lines 37-67 unchanged (fallback path)

## Behavior
- **Default**: Demo flow (no change)
- **With DIXIS_AGG_PROVIDER=pg**: Attempts PG aggregation via Prisma groupBy
- **Demo mode override**: `?demo=1` or `?mode=demo` → always uses demo flow
- **Error handling**: Any PG error → silent fallback to demo with console.warn
