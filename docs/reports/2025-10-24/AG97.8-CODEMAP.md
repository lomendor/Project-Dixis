# AG97.8 — CODEMAP

## File Movements

### frontend/tests/e2e/api-admin-orders-facets-aggregation.pg-e2e.spec.ts
- **Origin**: `frontend/tests/e2e/orders-facets-aggregation.pg-e2e.spec.ts`
- **Destination**: `frontend/tests/e2e/api-admin-orders-facets-aggregation.pg-e2e.spec.ts`
- **Reason**: Filename must match testMatch pattern `**/api-*.spec.ts` for CI project discovery

## Modified Files

### frontend/playwright.config.ts (lines 85-93)
- **Change**: Added new CI project `api-admin-ci`
- **Reason**: PG E2E test was not discoverable in CI mode (no matching project)
- **Impact**: Enables Playwright to discover and run admin/API tests in CI environment

**Code Added**:
```typescript
// CI: API/Admin tests (AG97.8 - PG E2E support)
{
  name: 'api-admin-ci',
  use: {
    ...devices['Desktop Chrome']
    // No storageState - API tests use direct requests
  },
  testMatch: ['**/admin-*.spec.ts', '**/api-*.spec.ts']
}
```

### .github/workflows/pg-e2e.yml (line 68)
- **Old**: `pnpm exec playwright test tests/e2e/orders-facets-aggregation.pg-e2e.spec.ts --reporter=line`
- **New**: `pnpm exec playwright test tests/e2e/api-admin-orders-facets-aggregation.pg-e2e.spec.ts --reporter=line`

## Why This Change

### Root Cause Analysis (Two Issues Found)

**Issue 1: Missing CI Project**
1. **CI Mode Projects**: Playwright config had only 2 CI projects:
   - `consumer-ci`: testMatch for smoke, auth-probe, shipping, checkout tests
   - `auth-ui`: testMatch for @no-auth tests
2. **Test Location**: PG E2E test in `tests/e2e/` directory
3. **Mismatch**: Test pattern didn't match any CI project testMatch
4. **Result**: "No tests found" error

**Issue 2: Filename Pattern Mismatch**
1. **Original Name**: `orders-facets-aggregation.pg-e2e.spec.ts`
2. **CI Project testMatch**: `['**/admin-*.spec.ts', '**/api-*.spec.ts']`
3. **Mismatch**: Filename doesn't start with "admin-" or "api-"
4. **Result**: Even after adding CI project, still "No tests found"

### Solution
1. **Added CI Project**: `api-admin-ci` with testMatch: `['**/admin-*.spec.ts', '**/api-*.spec.ts']`
2. **Renamed Test**: `orders-facets-aggregation.pg-e2e.spec.ts` → `api-admin-orders-facets-aggregation.pg-e2e.spec.ts`
3. **Updated Workflow**: Point to new filename in pg-e2e.yml

Now filename matches `**/api-*.spec.ts` pattern → test discoverable in CI!

## Impact
- **Test Discovery**: ✅ PG E2E test now discoverable in CI mode
- **Existing Tests**: ✅ No impact on consumer-ci or auth-ui projects
- **Local Mode**: ✅ No change - producer project already had admin-*.spec.ts pattern
- **Future Tests**: ✅ All admin/API tests automatically included in CI runs
