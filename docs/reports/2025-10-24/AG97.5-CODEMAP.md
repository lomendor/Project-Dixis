# AG97.5 â€” CODEMAP

## Modified Files

### scripts/ci/sync-ci-schema.ts
- **Lines 12-17**: Added ESM __dirname polyfill
  - Import `fileURLToPath` from `url`
  - Import `dirname` from `path`
  - Define `__filename` using `fileURLToPath(import.meta.url)`
  - Define `__dirname` using `dirname(__filename)`

- **Line 62**: Changed CommonJS check to ESM-safe
  - Old: `if (require.main === module)`
  - New: `if (import.meta.url === \`file://${process.argv[1]}\`)`

## Why These Changes

### __dirname in ESM
- CommonJS: `__dirname` is a global variable
- ESM: `__dirname` doesn't exist, must be derived from `import.meta.url`
- Solution: Standard Node.js ESM polyfill pattern

### require.main in ESM
- CommonJS: `require.main === module` checks if script is entry point
- ESM: `require` doesn't exist
- Solution: Compare `import.meta.url` with script path

### Impact
- **Zero runtime behavior change**: Same logic, ESM-compatible syntax
- **Fixes**: ReferenceError: __dirname is not defined in ES module scope
- **Enables**: Playwright webServer startup in pg-e2e workflow
