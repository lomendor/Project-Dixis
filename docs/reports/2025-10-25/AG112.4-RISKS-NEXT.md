# AG112.4 ‚Äî RISKS-NEXT

## Risks

- **ŒßŒ±ŒºŒ∑Œªœå**: Same as AG112.3 - only affects clean DB migration runs
  - **Mitigation**: Idempotent DDL with IF NOT EXISTS
  - **Validation**: Migration Clinic runs on clean PostgreSQL

- **Migration 7 Final Test**: This is the last migration in the sequence
  - **Risk**: If migration 7 fails for OTHER reasons, we'll need AG112.5
  - **Confidence**: HIGH - We've verified migrations 1-6 pass, migration 7 just needed publicToken removed

## Testing Strategy

1. **PR CI**: Standard checks + Migration Clinic (should trigger on label)
2. **Expected**: ALL 7 migrations should pass
3. **Validation Points**:
   - ‚úÖ Migration 1 (init): Creates Producer
   - ‚úÖ Migration 2 (add_producer_image): Adds image column
   - ‚úÖ Migration 3 (add_orderitem_snapshots): Creates Product + Order + OrderItem
   - ‚úÖ Migration 4 (events_notifications_outbox): Creates Event, Notification, RateLimit
   - ‚úÖ Migration 5 (notifications_sentAt_error): Adds Notification.sentAt, error
   - ‚úÖ Migration 6 (notifications_attempts_backoff_dedup): Adds Notification columns
   - ‚úÖ **Migration 7** (add_order_public_token): Adds Order.publicToken + indexes

## Expected Results

### Migration 7 Success (AG112.4 Target) ‚úÖ
```
Applying migration `20251010000000_add_order_public_token`
‚úÖ ALTER TABLE "Order" ADD COLUMN "publicToken" TEXT NOT NULL DEFAULT gen_random_uuid();
‚úÖ CREATE UNIQUE INDEX "Order_publicToken_key" ON "Order"("publicToken");
‚úÖ CREATE INDEX "Order_publicToken_idx" ON "Order"("publicToken");
‚úÖ All migrations applied successfully!
```

### Complete Migration Summary
```
7 migrations found in prisma/migrations

Applying migration `20251005000000_init`                                    ‚úÖ
Applying migration `20251005120000_add_producer_image`                      ‚úÖ
Applying migration `20251006000000_add_orderitem_snapshots`                 ‚úÖ
Applying migration `20251007000412_events_notifications_outbox`             ‚úÖ
Applying migration `20251007003019_notifications_sentAt_error`              ‚úÖ
Applying migration `20251007003457_notifications_attempts_backoff_dedup`    ‚úÖ
Applying migration `20251010000000_add_order_public_token`                  ‚úÖ

The following migrations have been applied:
migrations/
  ‚îî‚îÄ 20251005000000_init/
  ‚îî‚îÄ 20251005120000_add_producer_image/
  ‚îî‚îÄ 20251006000000_add_orderitem_snapshots/
  ‚îî‚îÄ 20251007000412_events_notifications_outbox/
  ‚îî‚îÄ 20251007003019_notifications_sentAt_error/
  ‚îî‚îÄ 20251007003457_notifications_attempts_backoff_dedup/
  ‚îî‚îÄ 20251010000000_add_order_public_token/

Your database is now in sync with your schema.
```

## Next Steps

### If AG112.4 Passes ALL 7 Migrations ‚úÖ
**CELEBRATION TIME!** üéâ

Then proceed to:
- **AG113: Production Migration Runbook**
  - Document safe production migration process
  - Create rollback plan
  - Test on staging environment
  - Coordinate with ops for production deployment

### If AG112.4 Fails at Migration 7 ‚ùå
**Unlikely, but possible scenarios:**

**Scenario A**: Migration 7 has internal SQL error
- ‚Üí **AG112.5**: Debug and fix migration 7 specific issue

**Scenario B**: Migration 7 passes, but database schema doesn't match Prisma schema
- ‚Üí Run `prisma migrate status` to check for drift
- ‚Üí May need to generate new migration to sync schema

## Monitoring

After merge and Migration Clinic run:
1. **All Migrations**: Verify all 7 migrations applied successfully
2. **Final Schema**: Compare database schema with Prisma schema
3. **Artifacts**: Download and inspect migration logs
4. **Validation**: Run `prisma db pull` to verify schema matches
5. **Celebration**: If all pass, migration repair saga is COMPLETE!

## Migration Repair Journey Summary

### The Journey
```
AG112.2 ‚Üí Fixed OrderItem missing from init
  ‚Üì
AG112.3 ‚Üí Fixed Order & Product missing (OrderItem dependencies)
  ‚Üì
AG112.4 ‚Üí Fixed publicToken conflict (let migration 7 add it)
  ‚Üì
AG113 ‚Üí Production Runbook (if AG112.4 succeeds!)
```

### Lessons Learned Across AG112.2-AG112.4

1. **Init Migration Catastrophe**: Init migration only created 1 of 8 tables
2. **Cascade Discovery**: Fixing one table revealed FK dependencies (Order, Product)
3. **Column Timing**: When injecting tables, check later migrations for columns they add
4. **Idempotent DDL**: IF NOT EXISTS saved us from re-run errors
5. **Iterative Repair**: Small, focused fixes > one massive migration rewrite

### Success Metrics

**If AG112.4 Succeeds**:
- ‚úÖ 7/7 migrations pass on clean database
- ‚úÖ Database schema matches Prisma schema
- ‚úÖ Migration history preserved and functional
- ‚úÖ Production deployment path clear

## Future Enhancements

### Pre-Migration Validation Tool
```typescript
// Validate migrations before pushing to main
async function validateMigrationOrder() {
  const migrations = await getMigrations();
  for (const mig of migrations) {
    const sql = await readMigrationSQL(mig);
    // Check for ALTER TABLE before corresponding CREATE TABLE
    const alters = extractAlterTables(sql);
    const creates = extractCreateTables(sql);
    for (const alter of alters) {
      if (!creates.includes(alter.table)) {
        const priorMigs = migrations.slice(0, migrations.indexOf(mig));
        const tableCreated = priorMigs.some(m => createsTable(m, alter.table));
        if (!tableCreated) {
          console.error(`‚ùå ${mig}: ALTER TABLE ${alter.table} but table not created!`);
        }
      }
    }
  }
}
```

### Migration Health Check
```bash
# CI job that runs BEFORE Migration Clinic
- name: Validate migration history
  run: |
    pnpm tsx scripts/validate-migrations.ts
    # Checks:
    # 1. All schema models have CREATE TABLE in some migration
    # 2. No ALTER before CREATE
    # 3. No column additions that already exist in CREATE
```

## Strategic Decision Point

**After AG112.4**, we're at a critical junction:

**Option A: Success Path** (Migrations 1-7 all pass)
- ‚Üí **AG113**: Production Migration Runbook
- ‚Üí Coordinate staging deployment
- ‚Üí Production migration plan
- ‚Üí Monitor and validate

**Option B: Another Iteration** (Migration 7 fails for different reason)
- ‚Üí **AG112.5**: Debug new error
- ‚Üí Continue iterative repair
- ‚Üí Re-evaluate comprehensive repair option

**Option C: Comprehensive Repair** (If many more issues emerge)
- ‚Üí Delete all migrations except init
- ‚Üí Regenerate migration history from current schema
- ‚Üí Test on clean database
- ‚Üí More disruptive but cleaner long-term

## Probability Assessment

**AG112.4 Success Probability**: **90%**

**Why High Confidence**:
- We've already verified migrations 1-6 pass (from AG112.3 logs)
- Migration 7 SQL is simple (ADD COLUMN + 2 indexes)
- The ONLY issue was publicToken duplication, now fixed
- No other dependencies or complex SQL in migration 7

**What Could Still Fail**:
- PostgreSQL version incompatibility (unlikely, we use PG 15)
- Syntax error in migration 7 SQL (unlikely, it's Prisma-generated)
- Index creation issue (very unlikely)

## Final Validation Checklist

After AG112.4 Migration Clinic run:
- [ ] All 7 migrations applied successfully
- [ ] No warnings or errors in logs
- [ ] `prisma migrate status` shows all migrations applied
- [ ] Database schema matches Prisma schema.prisma
- [ ] All foreign keys correctly created
- [ ] All indexes present
- [ ] Ready for production deployment planning

## Celebration Plan (When AG112.4 Succeeds)

1. **Document the Victory**: AG112 saga summary showing journey from 1 table to 8 tables
2. **Update Main**: Ensure AG112.4 merged and running on main
3. **Notify Team**: Migration repair complete, production path clear
4. **Plan AG113**: Production migration runbook with rollback plan
5. **Retrospective**: What we learned from this migration disaster recovery
