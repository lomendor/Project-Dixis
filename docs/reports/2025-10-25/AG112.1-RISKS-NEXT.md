# AG112.1 — RISKS-NEXT

## Risks
- **Πολύ χαμηλό**: Logic fix only, no new dependencies or infrastructure changes
- **Command order**: Standard Prisma migration pattern (deploy → status → validate)
  - **Mitigation**: Documented in Prisma best practices
  - **Testing**: Will validate on clean database in CI

## Testing Strategy
1. **PR CI**: Standard checks (typecheck, build, QA)
2. **Manual trigger on main**: After merge, run Migration Clinic
3. **Success criteria**:
   - ✅ Prisma migrate deploy succeeds
   - ✅ Prisma migrate status shows all applied
   - ✅ Prisma db validate succeeds
   - ✅ Migration artifacts uploaded

## Expected Results
- ✅ **Prisma generate**: Generates client successfully
- ✅ **Prisma migrate deploy**: Creates `_prisma_migrations` table + applies all 7 migrations
- ✅ **Prisma migrate status**: Shows "No pending migrations" (all applied)
- ✅ **Prisma db validate**: Schema matches migrations
- ✅ **Artifacts**: `frontend/prisma/migrations` uploaded with all migration files

## What Changed from AG112
**AG112 Order** (WRONG):
```
1. generate
2. status  ← ❌ Failed here (no table)
3. deploy  ← Never reached
4. validate
```

**AG112.1 Order** (CORRECT):
```
1. generate
2. deploy  ← ✅ Creates table + migrates
3. status  ← ✅ Confirms applied
4. validate ← ✅ Checks consistency
```

## Possible Failure Scenarios

### 1. Migration Apply Errors
**Symptom**: `prisma migrate deploy` fails with schema errors
**Diagnosis**: Check migration files for syntax or constraint issues
**Fix**: AG112.2 - Migration repair based on specific error

### 2. Schema Validation Errors
**Symptom**: `prisma db validate` fails
**Diagnosis**: Schema doesn't match applied migrations
**Fix**: Review schema.prisma vs migration files, reconcile differences

### 3. Database Connection Issues
**Symptom**: Cannot connect to postgres service
**Diagnosis**: Check postgres health check, DATABASE_URL environment
**Fix**: Verify service configuration, port mapping

## Next Steps

### If AG112.1 Passes ✅
**AG113: Production Migration Runbook**
- Document safe migration procedures for production
- Create rollback scripts and procedures
- Test on staging environment
- Schedule production migration window
- Monitor migration execution

### If AG112.1 Fails (Migration Errors) ❌
**AG112.2: Migration Repair**
- Analyze specific Prisma migration error from logs
- Review migration files and schema
- Create repair migration if needed
- Re-baseline migration state
- Re-run clinic to validate

## Future Enhancements

### Add Migration Diff Output
Show what migrations will be applied:
```yaml
- name: Show pending migrations
  run: pnpm prisma migrate status --json | jq '.pendingMigrations'
```

### Capture Migration Logs
Save detailed migration logs as artifacts:
```yaml
- name: Prisma migrate deploy (with logs)
  run: pnpm prisma migrate deploy 2>&1 | tee migration-deploy.log

- name: Upload logs
  uses: actions/upload-artifact@v4
  with:
    name: migration-logs
    path: frontend/migration-deploy.log
```

### Add Migration Rollback Test
Test rollback capability:
```yaml
- name: Test rollback (optional)
  run: |
    # Apply migrations
    pnpm prisma migrate deploy
    # Mark last migration as rolled back
    psql "$DATABASE_URL" -c "DELETE FROM _prisma_migrations WHERE migration_name = (SELECT migration_name FROM _prisma_migrations ORDER BY finished_at DESC LIMIT 1);"
    # Verify status shows pending
    pnpm prisma migrate status
```

## Monitoring
After merge and manual run:
1. **Deploy Step**: Verify all 7 migrations applied
2. **Status Step**: Confirm "No pending migrations" message
3. **Validate Step**: Confirm schema consistency
4. **Artifacts**: Download and inspect migration folder structure
5. **Logs**: Review Prisma output for warnings or deprecations
