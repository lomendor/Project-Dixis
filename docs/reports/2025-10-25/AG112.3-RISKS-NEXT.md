# AG112.3 — RISKS-NEXT

## Risks
- **Χαμηλό**: Εξακολουθεί να αφορά μόνο clean DB clinic runs
  - **Mitigation**: Idempotent DDL με IF NOT EXISTS
  - **Validation**: Migration Clinic θα τρέξει σε clean PostgreSQL

- **Incremental Complexity**: Πάμε από AG112.2 → AG112.3 → πιθανόν AG112.4+
  - **Risk**: Πολλαπλές iterative επιδιορθώσεις αυξάνουν πολυπλοκότητα
  - **Alternative**: Ολική αναδημιουργία migration history (πιο ριζική αλλαγή)

## Testing Strategy
1. **PR CI**: Standard checks + Migration Clinic (αν λειτουργεί το label)
2. **Expected**: Migrations 1-3 θα περάσουν, migration 4 μπορεί να αποτύχει (Event/Notification missing)
3. **Validation Points**:
   - ✅ Migration 1 (init): Creates Producer
   - ✅ Migration 2 (add_producer_image): Adds image column
   - ✅ **Migration 3** (add_orderitem_snapshots): Creates Product + Order + OrderItem
   - ❓ Migration 4 (events_notifications_outbox): Might fail if tries to use Event/Notification

## Expected Results

### Migration 3 Success (AG112.3 Target)
```
Applying migration `20251006000000_add_orderitem_snapshots`
✅ Created: Product table (with FK to Producer)
✅ Created: Order table (with indexes)
✅ Created: OrderItem table (with FKs to Order & Product)
✅ All foreign keys applied successfully
```

### Possible Migration 4 Failure (Next Issue)
```
Applying migration `20251007000412_events_notifications_outbox`
❌ Error: relation "Event" does not exist
   OR
❌ Error: relation "Notification" does not exist
```

## Next Steps

### If AG112.3 Passes Through Migration 3 ✅
**Two Scenarios**:

**Scenario A**: Migration 4 also passes (Event/Notification are created there)
- → Celebrate! Check if migrations 5-7 pass
- → If all 7 pass: **AG113 Production Runbook**

**Scenario B**: Migration 4 fails (Event/Notification missing)
- → **AG112.4**: Inject Event + Notification tables
- → Repeat pattern: extract DDL, inject into failing migration

### If AG112.3 Fails at Migration 3 ❌
**AG112.3.1**: Debug and fix specific error
- Analyze logs for exact failure point
- Could be FK ordering issue or missing dependency

### Strategic Decision Point

After AG112.3, evaluate:

**Option A: Continue Piecemeal** (current approach)
- Pros: Incremental, low-risk each step
- Cons: Many PRs, complex migration file
- **When**: If only 1-2 more tables missing

**Option B: Comprehensive Repair Migration**
- Create new migration that adds ALL missing tables at once
- Pros: Clean, complete solution
- Cons: Larger change, more to review
- **When**: If 4+ tables still missing

**Option C: Regenerate Migration History**
- Delete all migrations, regenerate from current schema
- Pros: Clean slate, matches schema perfectly
- Cons: Most disruptive, requires production migration plan
- **When**: If production DB never had these migrations applied

## Monitoring

After merge and Migration Clinic run:
1. **Migration 3**: Verify Product, Order, OrderItem all created
2. **Migration 4**: Check if passes or fails (determines next step)
3. **Artifacts**: Download migration folder, inspect all SQL
4. **Logs**: Review Prisma output for which migration failed (if any)
5. **Decision**: Based on results, choose Option A/B/C above

## Future Enhancements

### Migration Health Dashboard
Track migration history completeness:
```typescript
// Compare schema models vs tables in init migration
const schemaModels = await getSchemaModels();
const initTables = await getInitMigrationTables();
const missing = schemaModels.filter(m => !initTables.includes(m));
console.log(`Missing from init: ${missing.join(', ')}`);
```

### Pre-commit Migration Validation
```yaml
# Prevent commits with ALTER before CREATE
- name: Validate migration order
  run: |
    for mig in prisma/migrations/*/migration.sql; do
      if grep -q "ALTER TABLE" "$mig" && ! grep -q "CREATE TABLE" "$mig"; then
        echo "⚠️ $mig has ALTER without CREATE"
      fi
    done
```
