# AG112.4 — CODEMAP

## Modified File

### frontend/prisma/migrations/20251006000000_add_orderitem_snapshots/migration.sql
Removed publicToken column and related indexes from CREATE TABLE "Order" to prevent conflict with migration 7.

**Problem Evolution**:
- **AG112.3**: Added CREATE TABLE "Order" with publicToken column based on current schema
- **AG112.3 Run**: Failed at migration 7 with `ERROR: column "publicToken" of relation "Order" already exists`
- **AG112.4**: This fix - Removed publicToken from CREATE TABLE, let migration 7 add it

**Migration 7 Intent**:
Migration `20251010000000_add_order_public_token` is designed to:
```sql
ALTER TABLE "Order" ADD COLUMN "publicToken" TEXT NOT NULL DEFAULT gen_random_uuid();
CREATE UNIQUE INDEX "Order_publicToken_key" ON "Order"("publicToken");
CREATE INDEX "Order_publicToken_idx" ON "Order"("publicToken");
```

**Conflict**:
AG112.3 included publicToken in the initial CREATE TABLE, which meant migration 7's ALTER TABLE would fail.

## Changes Made

### Before AG112.4
```sql
-- CreateTable Order (injected by AG112.3 - missing from init migration)
CREATE TABLE IF NOT EXISTS "Order" (
    "id" TEXT NOT NULL,
    "publicToken" TEXT NOT NULL,  -- ❌ Conflicts with migration 7!
    "buyerPhone" TEXT NOT NULL,
    "buyerName" TEXT NOT NULL,
    "shippingLine1" TEXT NOT NULL,
    "shippingLine2" TEXT,
    "shippingCity" TEXT NOT NULL,
    "shippingPostal" TEXT NOT NULL,
    "total" DOUBLE PRECISION NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'pending',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "Order_pkey" PRIMARY KEY ("id")
);

-- CreateIndex for Order
CREATE UNIQUE INDEX IF NOT EXISTS "Order_publicToken_key" ON "Order"("publicToken");  -- ❌
CREATE INDEX IF NOT EXISTS "Order_buyerPhone_createdAt_idx" ON "Order"("buyerPhone", "createdAt");
CREATE INDEX IF NOT EXISTS "Order_status_createdAt_idx" ON "Order"("status", "createdAt");
CREATE INDEX IF NOT EXISTS "Order_publicToken_idx" ON "Order"("publicToken");  -- ❌
```

**Result**: Migration 7 fails trying to add column that already exists.

### After AG112.4
```sql
-- CreateTable Order (injected by AG112.3 - missing from init migration)
-- Note: publicToken column will be added by migration 20251010000000_add_order_public_token
CREATE TABLE IF NOT EXISTS "Order" (
    "id" TEXT NOT NULL,
    "buyerPhone" TEXT NOT NULL,
    "buyerName" TEXT NOT NULL,
    "shippingLine1" TEXT NOT NULL,
    "shippingLine2" TEXT,
    "shippingCity" TEXT NOT NULL,
    "shippingPostal" TEXT NOT NULL,
    "total" DOUBLE PRECISION NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'pending',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "Order_pkey" PRIMARY KEY ("id")
);

-- CreateIndex for Order (publicToken indexes will be added by migration 7)
CREATE INDEX IF NOT EXISTS "Order_buyerPhone_createdAt_idx" ON "Order"("buyerPhone", "createdAt");
CREATE INDEX IF NOT EXISTS "Order_status_createdAt_idx" ON "Order"("status", "createdAt");
```

**Result**: Migration 3 creates Order table WITHOUT publicToken, migration 7 adds it successfully.

## Migration Sequence After AG112.4

**Expected Flow**:
```
Migration 1 (init): ✅ Producer
Migration 2 (add_producer_image): ✅ Producer.imageUrl
Migration 3 (add_orderitem_snapshots): ✅ Product + Order (no publicToken) + OrderItem
Migration 4 (events_notifications_outbox): ✅ Event, Notification, RateLimit
Migration 5 (notifications_sentAt_error): ✅ Notification.sentAt, Notification.error
Migration 6 (notifications_attempts_backoff_dedup): ✅ Notification columns
Migration 7 (add_order_public_token): ✅ Order.publicToken + indexes
```

## Why This Approach

### Preserving Migration History Intent
Each migration file represents a historical point in schema evolution. Migration 7 was created to add publicToken, so we should let it do that job instead of pre-empting it in migration 3.

### Avoiding Future Conflicts
If we kept publicToken in migration 3, we'd need to either:
1. Make migration 7 idempotent with `ADD COLUMN IF NOT EXISTS` (modifying historical migration)
2. Delete migration 7 entirely (breaks migration history)
3. Remove publicToken from migration 3 (✅ chosen approach - least invasive)

### Clean Separation of Concerns
- **Migration 3**: Creates core Order table structure
- **Migration 7**: Adds publicToken feature to existing Order table

## Lessons Learned

**When Injecting Missing Tables**:
1. **Check ALL later migrations** for columns they might add to this table
2. **Only include columns that existed BEFORE the earliest ALTER migration**
3. **Document what's intentionally excluded** and why

**Migration Repair Strategy**:
```
1. Identify missing table (e.g., Order)
2. Find EARLIEST migration that modifies this table (e.g., migration 7 adds publicToken)
3. Inject CREATE TABLE with columns that existed BEFORE that migration
4. Let later migrations add their intended columns
```

**Example**:
If Order table is missing and migrations 7, 9, 12 all add columns:
- Migration 3 should create Order with ONLY columns before migration 7
- Migrations 7, 9, 12 add their columns via ALTER TABLE as intended

## What This Fixes

**Before AG112.4**:
```
Migration 7 sequence:
1. ALTER TABLE "Order" ADD COLUMN "publicToken" ... ❌
   ERROR: column "publicToken" of relation "Order" already exists
```

**After AG112.4**:
```
Migration 7 sequence:
1. ALTER TABLE "Order" ADD COLUMN "publicToken" ... ✅
2. CREATE UNIQUE INDEX "Order_publicToken_key" ... ✅
3. CREATE INDEX "Order_publicToken_idx" ... ✅
```

## Expected Next Issue

**Still Unknown**: Whether any migrations after #7 also have similar conflicts. We'll discover this when Migration Clinic runs on AG112.4.

**Migration 7 Status**: We verified from logs that migrations 1-6 passed in AG112.3 run, so migration 7 is the next frontier.

**Remaining Migrations**: If migration 7 passes, there are no more migrations to test (7 total migrations, 1-6 passed, 7 is the final one).

## Strategic Perspective

This is the **fourth iteration** of migration repair:
- **AG112.2**: Added OrderItem table
- **AG112.3**: Added Product + Order tables (with publicToken)
- **AG112.4**: Fixed Order table (removed publicToken)

**Success Criteria for AG112.4**: All 7 migrations pass in Migration Clinic on clean PostgreSQL database.

**If AG112.4 Succeeds**: Migration repair complete! Move to **AG113: Production Runbook**

**If AG112.4 Fails**: Analyze next error and continue iterative repair (likely AG112.5).
