# AG112.2 — RISKS-NEXT

## Risks
- **Χαμηλό**: Τροποποίηση μη-εφαρμοσμένης migration (safe for clean databases)
  - **Mitigation**: Idempotent DDL (IF NOT EXISTS) prevents issues if migration somehow ran partially
  - **Validation**: Migration Clinic will test on clean PostgreSQL

- **Foreign Key Dependencies**: Assumes Order & Product tables exist
  - **Mitigation**: These should be created by init migration
  - **Monitoring**: If FK creation fails, indicates deeper schema issues

- **Schema Drift**: OrderItem missing from init suggests schema regeneration issues
  - **Future Risk**: Other tables might have similar issues
  - **Recommendation**: Full schema audit after AG112.2 passes

## Testing Strategy
1. **PR CI**: Standard checks + **Migration Clinic** (label `migration-clinic`)
2. **Expected**: All 7 migrations apply successfully
3. **Validation Points**:
   - ✅ Migration 1 (init): Creates Producer
   - ✅ Migration 2 (add_producer_image): Adds column
   - ✅ **Migration 3** (add_orderitem_snapshots): Creates OrderItem table
   - ✅ Migrations 4-7: Apply successfully
   - ✅ Prisma migrate status: "No pending migrations"
   - ✅ Prisma db validate: Schema matches database

## Expected Results

### Migration Clinic Run (Clean DB)
```
Applying migration `20251005000000_init`
✅ Created: Producer table

Applying migration `20251005120000_add_producer_image`
✅ Added: Producer.image column

Applying migration `20251006000000_add_orderitem_snapshots`
✅ Created: OrderItem table (with indexes & FKs)
✅ Added: OrderItem.titleSnap, OrderItem.priceSnap (no-ops, already in CREATE)

Applying migration `20251007000412_events_notifications_outbox`
✅ Created: Event, Notification, RateLimit tables

Applying migration `20251007003019_notifications_sentAt_error`
✅ Modified: Notification schema

Applying migration `20251007003457_notifications_attempts_backoff_dedup`
✅ Modified: Notification indexes

Applying migration `20251010000000_add_order_public_token`
✅ Modified: Order table

All migrations applied successfully ✅
```

### Artifacts
- `frontend/prisma/migrations/` folder uploaded
- All 7 migration folders with SQL files
- Migration Clinic logs showing successful deployment

## Possible Failure Scenarios

### 1. Order/Product Tables Don't Exist
**Symptom**: Foreign key creation fails
**Error**: `ERROR: relation "Order" does not exist` or `relation "Product" does not exist`
**Diagnosis**: Init migration incomplete or corrupted
**Fix**: AG112.3 - Audit init migration, add missing tables

### 2. Remaining Migrations Fail
**Symptom**: Migrations 4-7 fail after OrderItem creation
**Diagnosis**: Check specific migration error
**Fix**: AG112.4 - Repair subsequent migrations based on error

### 3. Schema Validation Fails
**Symptom**: `prisma db validate` fails
**Error**: Schema doesn't match applied migrations
**Diagnosis**: Mismatch between schema.prisma and migration files
**Fix**: AG112.5 - Regenerate migrations from schema or fix schema to match migrations

## Next Steps

### If AG112.2 Passes ✅
**AG113: Production Migration Runbook**
- ✅ Migration Clinic validated on clean database
- Document production migration procedures
- Create rollback scripts
- Test on staging environment
- Schedule production migration window
- **Monitor**: Watch for OrderItem-related queries in production

### If AG112.2 Fails (FK Errors) ❌
**AG112.3: Init Migration Audit**
- Review `20251005000000_init/migration.sql`
- Identify all missing tables (Order, Product, etc.)
- Generate complete init migration from current schema
- Re-run Migration Clinic

### If AG112.2 Fails (Later Migrations) ❌
**AG112.4: Cascading Migration Repair**
- Analyze which migration (4-7) failed
- Apply same repair pattern (inject missing DDL)
- Re-run Migration Clinic

## Future Enhancements

### Schema Migration Audit Tool
Create script to validate migration consistency:
```bash
# Compare schema.prisma vs applied migrations
pnpm prisma migrate diff \
  --from-migrations prisma/migrations \
  --to-schema-datamodel prisma/schema.prisma \
  --script > schema-drift.sql

# If output is non-empty → schema drift detected
```

### Migration Health Check
Add to Migration Clinic workflow:
```yaml
- name: Check for schema drift
  run: |
    DRIFT=$(pnpm prisma migrate diff \
      --from-migrations prisma/migrations \
      --to-schema-datamodel prisma/schema.prisma \
      --script)
    if [ -n "$DRIFT" ]; then
      echo "⚠️ Schema drift detected:"
      echo "$DRIFT"
      exit 1
    fi
```

### Pre-commit Migration Validation
```yaml
# .husky/pre-commit (for migration changes)
if git diff --cached --name-only | grep -q "prisma/migrations"; then
  echo "Migration changes detected, running validation..."
  cd frontend && pnpm prisma migrate status
fi
```

## Monitoring

After merge and Migration Clinic run:
1. **All 7 migrations apply**: Confirm no errors
2. **Status check**: "No pending migrations"
3. **Validation check**: Schema matches database
4. **Artifacts**: Download and inspect all migration files
5. **Logs**: Review Prisma output for warnings
6. **Next**: If all pass → AG113 (Production Runbook)
