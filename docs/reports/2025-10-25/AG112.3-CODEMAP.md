# AG112.3 — CODEMAP

## Modified File

### frontend/prisma/migrations/20251006000000_add_orderitem_snapshots/migration.sql
Added Product and Order table DDL to fix FK reference errors.

**Problem Evolution**:
- **AG112.2**: Added OrderItem table, but OrderItem has FKs to Order & Product
- **AG112.2 Run**: Failed with `ERROR: relation "Order" does not exist`
- **AG112.3**: This fix - Added Product AND Order tables before OrderItem

**Dependency Chain**:
```
Producer (from init) ← Product ← OrderItem
                    Order ← OrderItem
```

**Final Migration Structure** (AG112.3):
```sql
1. CREATE TABLE IF NOT EXISTS "Product" (+ indexes + FK to Producer)
2. CREATE TABLE IF NOT EXISTS "Order" (+ indexes, no FKs)
3. CREATE TABLE IF NOT EXISTS "OrderItem" (+ indexes + FKs to Order & Product)
4. ALTER TABLE "OrderItem" ADD COLUMN (no-ops, columns already in CREATE)
```

## Tables Added in AG112.3

### Product Table
```sql
CREATE TABLE IF NOT EXISTS "Product" (
    "id" TEXT NOT NULL,
    "producerId" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "category" TEXT NOT NULL,
    "price" DOUBLE PRECISION NOT NULL,
    "unit" TEXT NOT NULL,
    "stock" INTEGER NOT NULL DEFAULT 0,
    "description" TEXT,
    "imageUrl" TEXT,
    "isActive" BOOLEAN NOT NULL DEFAULT true,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "Product_pkey" PRIMARY KEY ("id")
);

-- Indexes
CREATE INDEX IF NOT EXISTS "Product_producerId_createdAt_idx" ON "Product"("producerId", "createdAt");
CREATE INDEX IF NOT EXISTS "Product_category_idx" ON "Product"("category");
CREATE INDEX IF NOT EXISTS "Product_isActive_idx" ON "Product"("isActive");

-- FK to Producer (exists from init migration)
ALTER TABLE "Product" ADD CONSTRAINT "Product_producerId_fkey"
  FOREIGN KEY ("producerId") REFERENCES "Producer"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

### Order Table
```sql
CREATE TABLE IF NOT EXISTS "Order" (
    "id" TEXT NOT NULL,
    "publicToken" TEXT NOT NULL,
    "buyerPhone" TEXT NOT NULL,
    "buyerName" TEXT NOT NULL,
    "shippingLine1" TEXT NOT NULL,
    "shippingLine2" TEXT,
    "shippingCity" TEXT NOT NULL,
    "shippingPostal" TEXT NOT NULL,
    "total" DOUBLE PRECISION NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'pending',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "Order_pkey" PRIMARY KEY ("id")
);

-- Indexes
CREATE UNIQUE INDEX IF NOT EXISTS "Order_publicToken_key" ON "Order"("publicToken");
CREATE INDEX IF NOT EXISTS "Order_buyerPhone_createdAt_idx" ON "Order"("buyerPhone", "createdAt");
CREATE INDEX IF NOT EXISTS "Order_status_createdAt_idx" ON "Order"("status", "createdAt");
CREATE INDEX IF NOT EXISTS "Order_publicToken_idx" ON "Order"("publicToken");
```

## What This Fixes

**Before AG112.3**:
```
Migration 3 sequence:
1. CREATE TABLE "OrderItem" ✅
2. ADD FK "OrderItem_orderId_fkey" → "Order" ❌ Order doesn't exist!
   ERROR: relation "Order" does not exist
```

**After AG112.3**:
```
Migration 3 sequence:
1. CREATE TABLE "Product" ✅ (FK to Producer which exists)
2. CREATE TABLE "Order" ✅ (no FK dependencies)
3. CREATE TABLE "OrderItem" ✅ (FKs to Order & Product now exist!)
4. All FK constraints succeed ✅
```

## Expected Migration 4+ Issues

**Still Missing** (will likely cause future failures):
- Event table (migration 4 expects it)
- Notification table (migration 4 expects it)
- RateLimit table
- CheckoutOrder table

**Next Failure Prediction**: Migration 4 (`20251007000412_events_notifications_outbox`) will likely fail trying to use Event or Notification tables that don't exist.

**Long-term Solution**: This piecemeal repair approach is getting complex. After AG112.3, consider:
1. **Option A**: Continue piecemeal (AG112.4, AG112.5...) for each missing table
2. **Option B**: Regenerate entire migration history from current schema
3. **Option C**: Create one comprehensive repair migration that adds ALL missing tables

## Lessons Learned

**Migration Dependency Management**:
- Always create tables in dependency order (parent before child)
- Foreign keys require referenced tables to exist first
- Idempotent DDL (IF NOT EXISTS) is critical when repairing migrations

**Schema Drift Detection**:
- Init migration was created when schema had only 1 table
- 7 tables added incrementally without proper migrations
- Migration Clinic exposed this catastrophic drift
