# AG112.1 — CODEMAP

## Modified File

### .github/workflows/migration-clinic.yml
Fixed migration command order - deploy BEFORE status check on clean database.

**Key Change**:

**Before** (AG112 - BROKEN):
```yaml
- name: Prisma migrate status (prod schema)
  run: pnpm prisma migrate status    # ❌ Fails on clean DB

- name: Prisma migrate deploy (prod schema)
  run: pnpm prisma migrate deploy
```

**After** (AG112.1 - FIXED):
```yaml
- name: Prisma migrate deploy (prod schema)
  run: pnpm prisma migrate deploy    # ✅ Creates table & applies migrations

- name: Prisma migrate status (post-deploy check)
  run: pnpm prisma migrate status    # ✅ Now table exists
```

## What This Fixes

**Problem**: AG112 run failed with `ERROR: relation "_prisma_migrations" does not exist`
**Root Cause**: `prisma migrate status` expects `_prisma_migrations` table to exist, but on clean database it doesn't
**Solution**: Run `prisma migrate deploy` first (creates table), THEN `prisma migrate status` as verification

## Why This Matters

**Clean Database Scenario** (CI):
1. PostgreSQL service container starts empty
2. ❌ `migrate status` → Fails (no `_prisma_migrations` table)
3. `migrate deploy` → Would create table + apply migrations (never reached)

**Correct Order**:
1. PostgreSQL service container starts empty
2. ✅ `migrate deploy` → Creates `_prisma_migrations` + applies all migrations
3. ✅ `migrate status` → Confirms all migrations applied
4. ✅ `db validate` → Confirms schema consistency

## Expected Behavior

### Success Path (AG112.1)
1. ✅ Checkout code
2. ✅ Setup Node.js 20 (no cache)
3. ✅ Enable corepack & prepare pnpm@9
4. ✅ Show workspace diagnostic
5. ✅ Install dependencies
6. ✅ Prepare PostgreSQL databases
7. ✅ Generate Prisma client
8. ✅ **Deploy migrations** (creates table, applies migrations)
9. ✅ **Check status** (verifies all applied)
10. ✅ Validate schema
11. ✅ Upload migration artifacts

### What AG112 Did Wrong
- Step 8 & 9 were reversed
- `migrate status` ran before `_prisma_migrations` table existed
- Workflow failed at step 8, never reached deployment

## Lessons Learned

**Prisma Migration Commands**:
- `migrate status` → **Read-only**, checks if migrations applied
- `migrate deploy` → **Writes**, creates tracking table + applies migrations
- **Order matters** on clean database: deploy → status → validate
