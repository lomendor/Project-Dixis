# AG112.2 — CODEMAP

## Modified File

### frontend/prisma/migrations/20251006000000_add_orderitem_snapshots/migration.sql
Repaired migration by injecting complete OrderItem table DDL.

**Problem Identified**:
- **Init migration** (`20251005000000_init`) only creates `Producer` table
- **OrderItem table** is missing from init migration
- **3rd migration** (`20251006000000_add_orderitem_snapshots`) tries to `ALTER TABLE "OrderItem"` → fails because table doesn't exist

**Root Cause**:
The Prisma schema contains OrderItem model, but the init migration was generated when OrderItem didn't exist yet in the schema, or the init migration was manually trimmed/edited.

**Solution Applied**:
Injected complete CREATE TABLE "OrderItem" DDL into the failing migration:

**Before** (AG112.1 - BROKEN):
```sql
-- AlterTable
ALTER TABLE "OrderItem" ADD COLUMN "titleSnap" TEXT;
ALTER TABLE "OrderItem" ADD COLUMN "priceSnap" DOUBLE PRECISION;
```
❌ Fails with: `ERROR: relation "OrderItem" does not exist`

**After** (AG112.2 - FIXED):
```sql
-- CreateTable (injected by AG112.2 - missing from init migration)
CREATE TABLE IF NOT EXISTS "OrderItem" (
    "id" TEXT NOT NULL,
    "orderId" TEXT NOT NULL,
    "productId" TEXT NOT NULL,
    "producerId" TEXT NOT NULL,
    "qty" INTEGER NOT NULL,
    "price" DOUBLE PRECISION NOT NULL,
    "titleSnap" TEXT,
    "priceSnap" DOUBLE PRECISION,
    "status" TEXT NOT NULL DEFAULT 'pending',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "OrderItem_pkey" PRIMARY KEY ("id")
);

-- CreateIndex (with IF NOT EXISTS for idempotency)
CREATE INDEX IF NOT EXISTS "OrderItem_orderId_idx" ON "OrderItem"("orderId");
CREATE INDEX IF NOT EXISTS "OrderItem_producerId_status_idx" ON "OrderItem"("producerId", "status");
CREATE INDEX IF NOT EXISTS "OrderItem_productId_idx" ON "OrderItem"("productId");

-- AddForeignKey (with conditional check to prevent duplicates)
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'OrderItem_orderId_fkey') THEN
    ALTER TABLE "OrderItem" ADD CONSTRAINT "OrderItem_orderId_fkey"
      FOREIGN KEY ("orderId") REFERENCES "Order"("id") ON DELETE CASCADE ON UPDATE CASCADE;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'OrderItem_productId_fkey') THEN
    ALTER TABLE "OrderItem" ADD CONSTRAINT "OrderItem_productId_fkey"
      FOREIGN KEY ("productId") REFERENCES "Product"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
  END IF;
END $$;

-- AlterTable (original migration - now redundant but kept for history)
ALTER TABLE "OrderItem" ADD COLUMN IF NOT EXISTS "titleSnap" TEXT;
ALTER TABLE "OrderItem" ADD COLUMN IF NOT EXISTS "priceSnap" DOUBLE PRECISION;
```

## Key Design Decisions

### 1. Idempotency
All DDL statements use `IF NOT EXISTS` / `IF EXISTS` checks:
- `CREATE TABLE IF NOT EXISTS` - Safe to run multiple times
- `CREATE INDEX IF NOT EXISTS` - Won't fail if index exists
- `DO $$ BEGIN ... IF NOT EXISTS ...` - Conditional FK creation
- `ADD COLUMN IF NOT EXISTS` - Safe column addition

**Why**: Migration might be applied in different environments at different times. Idempotency prevents failures on re-runs.

### 2. Included titleSnap/priceSnap in CREATE TABLE
The original migration was meant to ADD these columns, but since we're creating the table from scratch, we include them directly with NULL defaults.

**Result**: The ALTER statements become no-ops but are kept for migration history clarity.

### 3. Foreign Keys Reference Order & Product
Assumes these tables exist from init migration (they should, based on schema dependencies).

**Risk Mitigation**: If they don't exist, this migration will still fail, but that would indicate a deeper schema problem requiring investigation.

## Expected Behavior

### Clean Database (CI)
1. ✅ Init migration creates Producer table
2. ✅ Producer image migration adds image column
3. ✅ **This migration** creates OrderItem table + adds snapshot columns in one step
4. ✅ Subsequent migrations continue normally

### Existing Database (if any)
- If OrderItem already exists: All IF NOT EXISTS checks prevent errors
- If OrderItem partially exists: Idempotent operations fill gaps safely
- If OrderItem doesn't exist: Creates it properly with all columns

## What This Fixes

**Before AG112.2**:
```
Migration deploy sequence:
1. init → ✅ Creates Producer
2. add_producer_image → ✅ Adds image column
3. add_orderitem_snapshots → ❌ Tries to ALTER non-existent OrderItem
   ERROR: relation "OrderItem" does not exist
```

**After AG112.2**:
```
Migration deploy sequence:
1. init → ✅ Creates Producer
2. add_producer_image → ✅ Adds image column
3. add_orderitem_snapshots → ✅ Creates OrderItem + adds snapshot columns
4-7. Remaining migrations → ✅ Should proceed normally
```

## Lessons Learned

**Migration Dependency Management**:
- Always ensure CREATE TABLE migrations come before ALTER TABLE migrations
- When regenerating schema migrations, validate that all tables are created before being altered
- Consider using `prisma migrate reset` + `prisma migrate dev` to regenerate clean migration history
- For production fixes, inject missing DDL into earliest failing migration rather than creating new "repair" migrations
