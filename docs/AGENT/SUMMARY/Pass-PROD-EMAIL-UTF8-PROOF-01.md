# Pass: PROD-EMAIL-UTF8-PROOF-01

**Date (UTC):** 2026-01-21 00:00
**Local Time:** 2026-01-21 02:00 (Europe/Athens)
**Deployed Commit:** b52072d4 (EMAIL-UTF8-01)
**Environment:** Production (https://dixis.gr)

---

## Objective

Verify in production that Greek text in transactional emails renders correctly after EMAIL-UTF8-01 fix (commit b52072d4).

---

## Result

| Check | Status |
|-------|--------|
| Email configuration | ✅ PASS |
| Password reset API | ✅ PASS |
| Email received | ✅ PASS |
| Subject Greek text | ✅ PASS — "Επαναφορά Κωδικού - Dixis" displays correctly |
| HTML body Greek text | ⚠️ UNKNOWN — visual rendering in Gmail appears OK |
| **text/plain body Greek text** | ❌ FAIL — mojibake observed via Gmail API extraction |

**Overall:** ⚠️ PARTIAL PASS

---

## Observed Issue

### Symptom

When extracting email content via Gmail API (or viewing in text-only clients), the `text/plain` part of the password reset email shows mojibake (garbled Greek characters).

**Example:**
- Expected: `Γεια σας`
- Observed: `Î"ÎµÎ¹Î± ÏƒÎ±Ï‚` (or similar garbled output)

### Impact

| Client Type | Affected |
|-------------|----------|
| Gmail (HTML view) | ❌ NO — appears OK |
| Gmail API extraction | ✅ YES — mojibake in text/plain |
| Text-only email clients | ✅ YES — mojibake |
| Screen readers | ✅ YES — likely affected |
| Email archiving systems | ✅ YES — mojibake in extracted text |

### Root Cause Analysis

The EMAIL-UTF8-01 fix (commit b52072d4) only addressed the HTML part charset via `$message->html($body, 'utf-8')`. The `text/plain` part is auto-generated by Laravel/Symfony mailer from the HTML, but:

1. The Content-Transfer-Encoding may not be set correctly (needs `quoted-printable` or `base64`)
2. The text/plain Content-Type header may not include `charset=UTF-8`
3. Laravel's automatic HTML-to-text conversion may not preserve encoding

---

## Pre-Flight Checks

### Production Email Configuration

```json
// GET https://dixis.gr/api/healthz → .email
{
  "flag": "enabled",
  "mailer": "resend",
  "configured": true,
  "from_configured": true,
  "keys_present": {
    "resend": true
  }
}
```

### Production Health

```
✅ Backend Health: 200
✅ Products API: 200
✅ Products List Page: 200
✅ Product Detail Page: 200
✅ Login Page: 200
```

---

## Email Trigger Action

**Method:** Password Reset Request
**Endpoint:** `POST https://dixis.gr/api/v1/auth/password/forgot`
**Payload:** `{"email": "kourkoutisp@gmail.com"}`

**API Response:**
```json
{
  "message": "If an account exists with this email, you will receive a password reset link."
}
```

**Timestamp:** 2026-01-21 00:00 UTC

---

## Follow-Up Required

**Pass:** EMAIL-UTF8-02
**Scope:** Fix text/plain part encoding

Required changes:
1. Ensure `text/plain` part has `Content-Type: text/plain; charset=UTF-8`
2. Ensure `Content-Transfer-Encoding: quoted-printable` or `base64`
3. Add test coverage for text/plain part Greek text

---

## Fix Reference (EMAIL-UTF8-01)

**Pass:** EMAIL-UTF8-01
**Commit:** b52072d4
**PR:** #2357
**Files:**
- `backend/app/Providers/MailEncodingServiceProvider.php` - UTF-8 charset enforcement
- `backend/tests/Feature/MailEncodingTest.php` - Automated verification

**Fix mechanism:** The `MailEncodingServiceProvider` hooks into Laravel's `MessageSending` event to:
1. Set `charset=UTF-8` on HTML body via `$message->html($body, 'utf-8')`
2. Set `charset=UTF-8` on text body via `$message->text($body, 'utf-8')`
3. Add `X-Dixis-Charset: UTF-8` header for verification

**Limitation:** The `$message->text($body, 'utf-8')` call may not be sufficient if the text body is auto-generated from HTML after the event fires, or if the underlying Symfony mailer doesn't apply the charset correctly to the MIME part.

---

_Pass: PROD-EMAIL-UTF8-PROOF-01 | Generated: 2026-01-21 | Updated: 2026-01-21 | Author: Claude_
