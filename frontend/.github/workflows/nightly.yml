name: Nightly E2E Tests & Reports

on:
  schedule:
    # Run at 2 AM UTC every night
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggers

env:
  NODE_VERSION: '20.x'
  NEXT_TELEMETRY_DISABLED: '1'

jobs:
  nightly-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: pnpm run build

      - name: Run E2E smoke tests
        run: pnpm run e2e:smoke
        env:
          CI: true

      - name: Generate nightly report
        if: always()
        run: |
          # Create nightly reports directory
          mkdir -p docs/reports/nightly

          # Generate date-stamped report
          DATE=$(date +%Y-%m-%d)
          REPORT_FILE="docs/reports/nightly/${DATE}.md"

          # Create nightly summary report
          cat > "$REPORT_FILE" << 'EOF'
          # ðŸŒ™ Nightly Test Report - ${{ github.run_id }}

          **Date**: $(date +"%Y-%m-%d %H:%M:%S UTC")
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Run ID**: ${{ github.run_id }}

          ---

          ## ðŸ§ª E2E Smoke Tests

          **Status**: ${{ job.status }}
          **Duration**: ${{ steps.e2e.conclusion == 'success' && 'âœ… Completed' || 'âŒ Failed' }}

          ### Test Scenarios Executed
          - ðŸ” Consumer authentication flow
          - ðŸ›’ Product browsing and cart operations
          - ðŸ“¦ Checkout process validation
          - ðŸ  Producer dashboard access
          - ðŸ“± Mobile navigation and responsive behavior

          ### System Health Check
          - **Frontend Build**: ${{ steps.build.conclusion == 'success' && 'âœ… Success' || 'âŒ Failed' }}
          - **Playwright Setup**: ${{ steps.playwright.conclusion == 'success' && 'âœ… Success' || 'âŒ Failed' }}
          - **Dependencies**: ${{ steps.deps.conclusion == 'success' && 'âœ… Success' || 'âŒ Failed' }}

          ---

          ## ðŸ“Š Environment Information

          - **Node.js**: ${{ env.NODE_VERSION }}
          - **Runner**: ubuntu-latest
          - **Browser**: Chromium (Playwright)
          - **Timeout**: 30 minutes

          ---

          ## ðŸ”— Useful Links

          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Latest Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - [Test Artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)

          ---

          *Generated by Nightly CI - ${{ github.workflow }}*
          EOF

      - name: Commit nightly report
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          DATE=$(date +%Y-%m-%d)
          REPORT_FILE="docs/reports/nightly/${DATE}.md"

          if [ -f "$REPORT_FILE" ]; then
            git add "$REPORT_FILE"
            git commit -m "docs(nightly): add automated test report for $DATE

            Nightly E2E smoke test execution results:
            - Status: ${{ job.status }}
            - Run ID: ${{ github.run_id }}
            - Commit: ${{ github.sha }}

            ðŸ¤– Generated automatically by nightly CI workflow"

            git push
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-test-results-${{ github.run_number }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: Notify on failure
        if: failure()
        run: |
          echo "ðŸš¨ Nightly tests failed!"
          echo "Check the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"