name: PROD Facts - Daily Monitoring

on:
  # Manual trigger
  workflow_dispatch:

  # Daily at 07:00 UTC
  schedule:
    - cron: '0 7 * * *'

jobs:
  check-production:
    name: Check Production Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run PROD facts script
        id: prod-facts
        run: |
          # Script outputs to docs/OPS/.local/ (gitignored)
          bash scripts/prod-facts.sh
          echo "Script completed with exit code: $?"

      - name: Upload PROD facts report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prod-facts-report-${{ github.run_id }}
          path: docs/OPS/.local/PROD-FACTS-LAST.md
          retention-days: 30
          if-no-files-found: warn

      - name: Create GitHub Issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'docs/OPS/.local/PROD-FACTS-LAST.md';
            let reportContent = 'Report not generated';

            try {
              reportContent = fs.readFileSync(reportPath, 'utf8');
            } catch (err) {
              reportContent = `Error reading report: ${err.message}`;
            }

            const issueBody = `## PROD Facts Check Failed

**Workflow Run**: ${context.payload.repository.html_url}/actions/runs/${context.runId}
**Timestamp**: ${new Date().toISOString()}

### Report

\`\`\`
${reportContent}
\`\`\`

### Actions Required

1. Check production endpoints manually: https://dixis.gr/api/healthz
2. Run \`./scripts/prod-facts.sh\` locally for details
3. Update docs/OPS/STATE.md if issue persists
4. Close this issue after resolving

### Related Files

- \`scripts/prod-facts.sh\`
- \`docs/OPS/STATE.md\`

---
Auto-generated by prod-facts.yml workflow`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `PROD Facts Check Failed - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['ops', 'production', 'monitoring']
            });
