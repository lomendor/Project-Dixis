name: PROD Facts - Daily Monitoring

on:
  # Manual trigger
  workflow_dispatch:

  # Daily at 07:00 UTC
  schedule:
    - cron: '0 7 * * *'

jobs:
  check-production:
    name: Check Production Endpoints
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run PROD facts script
        run: bash scripts/prod-facts.sh

      - name: Commit updated PROD facts report
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/OPS/PROD-FACTS-LAST.md
          git diff --staged --quiet || git commit -m "chore(ops): update PROD facts report [skip ci]"
          git push || true

      - name: Upload PROD facts report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prod-facts-report
          path: docs/OPS/PROD-FACTS-LAST.md
          retention-days: 30

      - name: Create GitHub Issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'docs/OPS/PROD-FACTS-LAST.md';
            let reportContent = 'Report not generated';

            try {
              reportContent = fs.readFileSync(reportPath, 'utf8');
            } catch (err) {
              reportContent = `Error reading report: ${err.message}`;
            }

            const issueBody = `## ðŸš¨ PROD Facts Check Failed

**Workflow Run**: ${context.payload.repository.html_url}/actions/runs/${context.runId}
**Timestamp**: ${new Date().toISOString()}

### Report

\`\`\`
${reportContent}
\`\`\`

### Actions Required

1. Check production endpoints manually: https://dixis.gr/api/healthz
2. Review PROD-FACTS-LAST.md for specific failures
3. Update docs/OPS/STATE.md if issue persists
4. Close this issue after resolving

### Related Files

- \`scripts/prod-facts.sh\`
- \`docs/OPS/PROD-FACTS-LAST.md\`
- \`docs/OPS/STATE.md\`

---
ðŸ¤– Auto-generated by prod-facts.yml workflow`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ PROD Facts Check Failed - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['ops', 'production', 'monitoring']
            });
