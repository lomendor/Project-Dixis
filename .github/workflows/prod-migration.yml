name: Production Migration

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type EXACTLY: DIXIS-PROD-OK'
        required: true
        default: 'TYPE_HERE'

jobs:
  migrate:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'DIXIS-PROD-OK' }}

    concurrency:
      group: prod-migration
      cancel-in-progress: false

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable corepack & pnpm
        run: |
          set -e
          corepack enable
          corepack prepare pnpm@9 --activate
          pnpm -v

      - name: Verify secret presence
        env:
          DATABASE_URL_PROD: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          if [ -z "${DATABASE_URL_PROD:-}" ]; then
            echo "❌ Missing secret: DATABASE_URL_PROD"
            exit 1
          fi
          echo "✅ DATABASE_URL_PROD exists"

      - name: Sanity (print host/db)  # never prints password
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          set -e
          node -e "const u=new URL(process.env.DATABASE_URL); console.log('Host='+u.hostname,'DB='+decodeURIComponent(u.pathname.slice(1)),'sslmode='+u.searchParams.get('sslmode'))"

      - name: Install Postgres client (psql)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

      - name: Wait & probe Neon (pg_isready, up to 10m)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          set -e
          HOST="$(node -e "const u=new URL(process.env.DATABASE_URL); process.stdout.write(u.hostname)")"
          DB="$(node -e "const u=new URL(process.env.DATABASE_URL); process.stdout.write(decodeURIComponent(u.pathname.slice(1)))")"
          for i in $(seq 1 120); do
            echo "[probe $i/120] pg_isready $HOST:5432 db=$DB ..."
            if pg_isready -h "$HOST" -p 5432 -d "$DB" >/dev/null 2>&1; then
              echo "Neon is ready ✅"
              echo "Waiting 15s for Neon to fully stabilize..."
              sleep 15
              break
            fi
            sleep 5
          done

      - name: Warm-up keep-awake (30s with psql SELECT 1)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          set -e
          for i in $(seq 1 6); do
            echo "[warmup $i/6] SELECT 1 ..."
            psql "$DATABASE_URL" -c "SELECT 1" >/dev/null
            sleep 5
          done
          echo "Warm-up done."

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
          PRISMA_HIDE_UPDATE_MESSAGE: 1
        run: pnpm prisma generate

      - name: Prisma migrate deploy (PRODUCTION)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
          PRISMA_HIDE_UPDATE_MESSAGE: 1
        run: pnpm prisma migrate deploy

      - name: Prisma migrate status (post-deployment)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
          PRISMA_HIDE_UPDATE_MESSAGE: 1
        run: pnpm prisma migrate status

      - name: Prisma validate (post-deployment)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
          PRISMA_HIDE_UPDATE_MESSAGE: 1
        run: pnpm prisma validate

      - name: Summary
        if: success()
        run: |
          echo "✅ Production migration completed successfully!"
          echo "Next: verify health endpoints & run smoke."
