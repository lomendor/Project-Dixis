name: Monitor Uptime v2

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch:

concurrency:
  group: monitor-uptime
  cancel-in-progress: true

jobs:
  prod-http-smoke:
    name: Production HTTP Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - name: Test /api/healthz endpoint
        id: healthz
        run: |
          echo "ü©∫ Testing production health endpoint..."
          if ! RESPONSE=$(curl -fsS -w "\nHTTP_CODE:%{http_code}" https://dixis.gr/api/healthz 2>&1); then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "url=https://dixis.gr/api/healthz" >> $GITHUB_OUTPUT
            echo "error=$RESPONSE" >> $GITHUB_OUTPUT
            exit 1
          fi

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "url=https://dixis.gr/api/healthz" >> $GITHUB_OUTPUT
            echo "error=HTTP $HTTP_CODE" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ Health endpoint: HTTP $HTTP_CODE"
          echo "$BODY"

      - name: Test /auth/login endpoint
        id: login
        run: |
          echo "üîê Testing login page..."
          HTTP_CODE=$(curl -fsS -o /dev/null -w "%{http_code}" https://dixis.gr/auth/login 2>&1 || echo "failed")

          if [[ "$HTTP_CODE" =~ ^(5[0-9]{2})$ ]]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "url=https://dixis.gr/auth/login" >> $GITHUB_OUTPUT
            echo "error=HTTP $HTTP_CODE (5xx error)" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ Login page: HTTP $HTTP_CODE"

      - name: Test /products endpoint
        id: products
        run: |
          echo "üõí Testing products page..."
          HTTP_CODE=$(curl -fsS -o /dev/null -w "%{http_code}" https://dixis.gr/products 2>&1 || echo "failed")

          if [[ "$HTTP_CODE" =~ ^(5[0-9]{2})$ ]]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "url=https://dixis.gr/products" >> $GITHUB_OUTPUT
            echo "error=HTTP $HTTP_CODE (5xx error)" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ Products page: HTTP $HTTP_CODE"

      - name: Create alert issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const utcTimestamp = new Date().toISOString();
            const failedStep = '${{ steps.healthz.outputs.status }}' === 'failed' ? 'healthz' :
                               '${{ steps.login.outputs.status }}' === 'failed' ? 'login' : 'products';

            const failedUrl = failedStep === 'healthz' ? '${{ steps.healthz.outputs.url }}' :
                              failedStep === 'login' ? '${{ steps.login.outputs.url }}' : '${{ steps.products.outputs.url }}';

            const failedError = failedStep === 'healthz' ? '${{ steps.healthz.outputs.error }}' :
                                failedStep === 'login' ? '${{ steps.login.outputs.error }}' : '${{ steps.products.outputs.error }}';

            const issueBody = `## MONITOR-ALERT: Production Smoke Test Failed

Timestamp (UTC): ${utcTimestamp}
Failed Endpoint: ${failedUrl}
Error: ${failedError}
Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

### Next Steps
1. Check VPS health: 'ssh deploy@STAGING_HOST "pm2 list && curl -I http://localhost:3000/api/health"'
2. Check nginx status: 'ssh deploy@STAGING_HOST "sudo systemctl status nginx"'
3. Check PM2 logs: 'ssh deploy@STAGING_HOST "pm2 logs dixis-frontend --lines 50"'
4. Verify DNS: 'nslookup dixis.gr'
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® MONITOR-ALERT: Production smoke failed (${failedStep})`,
              body: issueBody,
              labels: ['monitoring', 'alert', 'production']
            });

  staging-internal-smoke:
    name: Staging Internal Smoke (Best-effort)
    runs-on: ubuntu-latest
    environment: staging
    continue-on-error: true  # Non-blocking if staging secrets missing
    steps:
      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$STAGING_HOST" ] || [ -z "$STAGING_USER" ]; then
            echo "‚ö†Ô∏è  Staging secrets not configured, skipping internal smoke test"
            exit 0
          fi

          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Internal health check
        id: staging_health
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
        run: |
          if [ -z "$STAGING_HOST" ] || [ -z "$STAGING_USER" ]; then
            echo "‚ö†Ô∏è  Skipping (no secrets)"
            exit 0
          fi

          echo "ü©∫ Testing staging internal health..."
          ssh -i ~/.ssh/id_ed25519 -o ConnectTimeout=10 ${STAGING_USER}@${STAGING_HOST} bash <<'HEALTH_CHECK'
          set -euo pipefail

          # Discover PORT from nginx config
          PORT=$(sudo nginx -T 2>/dev/null | grep -A 10 'server_name staging.dixis.io' | grep 'proxy_pass' | grep -oP '127.0.0.1:\K\d+' | head -1 || echo "3001")
          echo "üîç Testing port $PORT..."

          # Call health endpoint
          if ! RESPONSE=$(curl -fsS -m 10 http://localhost:$PORT/api/healthz 2>&1); then
            echo "‚ùå Staging health check FAILED: $RESPONSE"
            exit 1
          fi

          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            echo "‚úÖ Staging health check PASSED"
            exit 0
          else
            echo "‚ùå Staging health check FAILED - invalid response"
            exit 1
          fi
          HEALTH_CHECK

      - name: Create alert issue on staging failure
        if: failure() && steps.staging_health.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const utcTimestamp = new Date().toISOString();

            const issueBody = `## MONITOR-ALERT: Staging Internal Smoke Failed

Timestamp (UTC): ${utcTimestamp}
Test: Internal health check via SSH localhost
Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

### Next Steps
1. SSH to staging: 'ssh $STAGING_USER@$STAGING_HOST'
2. Check PM2 status: 'pm2 list'
3. Check PM2 logs: 'pm2 logs dixis-staging --lines 50'
4. Manual health check: 'curl http://localhost:3001/api/healthz'
5. Check nginx config: 'sudo nginx -T | grep -A 10 "staging.dixis.io"'
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® MONITOR-ALERT: Staging internal smoke failed',
              body: issueBody,
              labels: ['monitoring', 'alert', 'staging']
            });
