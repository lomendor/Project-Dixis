name: prod-smoke

on:
  schedule:
    - cron: '*/10 * * * *'   # κάθε 10 λεπτά
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Check /api/healthz
        run: |
          set -e
          OUT="$(curl -sS https://dixis.gr/api/healthz || true)"
          echo "$OUT"
          echo "$OUT" | jq -e '.status == "ok"' >/dev/null

      - name: Check /api/products shape
        run: |
          set -e
          OUT="$(curl -sS https://dixis.gr/api/products || true)"
          echo "$OUT"
          echo "$OUT" | jq -e 'has("source") and has("items") and (.items | type=="array")' >/dev/null

      - name: Check /products HTTP 200
        run: |
          set -e
          CODE=$(curl -s -o /dev/null -w "%{http_code}" https://dixis.gr/products)
          echo "status=$CODE"
          [ "$CODE" -eq 200 ]
