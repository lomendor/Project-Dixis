name: Production Smoke Tests

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'false'

jobs:
  prod-smoke:
    name: PROD Endpoint Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check PROD healthz endpoint
        run: |
          echo "=== Checking healthz endpoint ==="
          HTTP_CODE=$(curl --fail --retry 3 --retry-delay 2 \
            --connect-timeout 10 --max-time 20 \
            -sS -o /dev/null -w '%{http_code}' \
            https://dixis.gr/api/healthz)

          echo "healthz HTTP code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ FAIL: healthz returned $HTTP_CODE (expected 200)"
            exit 1
          fi

          echo "✅ PASS: healthz endpoint healthy"

      - name: Check PROD API products endpoint
        run: |
          echo "=== Checking API products endpoint ==="
          RESPONSE=$(curl --fail --retry 3 --retry-delay 2 \
            --connect-timeout 10 --max-time 20 \
            -sS https://dixis.gr/api/v1/public/products)

          HTTP_CODE=$(curl --retry 3 --retry-delay 2 \
            --connect-timeout 10 --max-time 20 \
            -sS -o /dev/null -w '%{http_code}' \
            https://dixis.gr/api/v1/public/products)

          echo "API products HTTP code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ FAIL: API products returned $HTTP_CODE (expected 200)"
            exit 1
          fi

          # Check response contains "data" key
          if ! echo "$RESPONSE" | grep -q '"data"'; then
            echo "❌ FAIL: API products response missing 'data' key"
            echo "Response preview: $(echo "$RESPONSE" | head -c 500)"
            exit 1
          fi

          echo "✅ PASS: API products endpoint healthy with data"

      - name: Check PROD products page
        run: |
          echo "=== Checking products page ==="
          HTTP_CODE=$(curl --fail --retry 3 --retry-delay 2 \
            --connect-timeout 10 --max-time 20 \
            -sS -o /dev/null -w '%{http_code}' \
            https://dixis.gr/products)

          echo "Products page HTTP code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ FAIL: Products page returned $HTTP_CODE (expected 200)"
            exit 1
          fi

          echo "✅ PASS: Products page accessible"

      - name: Check PROD auth redirects
        run: |
          echo "=== Checking auth redirects ==="

          # Check /login redirect
          LOGIN_CODE=$(curl -sS -o /dev/null -w '%{http_code}' \
            --connect-timeout 10 --max-time 20 \
            https://dixis.gr/login)

          if [ "$LOGIN_CODE" != "307" ] && [ "$LOGIN_CODE" != "302" ]; then
            echo "❌ FAIL: /login returned $LOGIN_CODE (expected 307 or 302)"
            exit 1
          fi

          # Check /register redirect
          REGISTER_CODE=$(curl -sS -o /dev/null -w '%{http_code}' \
            --connect-timeout 10 --max-time 20 \
            https://dixis.gr/register)

          if [ "$REGISTER_CODE" != "307" ] && [ "$REGISTER_CODE" != "302" ]; then
            echo "❌ FAIL: /register returned $REGISTER_CODE (expected 307 or 302)"
            exit 1
          fi

          echo "✅ PASS: Auth redirects working (login=$LOGIN_CODE, register=$REGISTER_CODE)"

      - name: Check PROD orders page
        run: |
          echo "=== Checking orders page ==="
          ORDERS_CODE=$(curl -sS -o /dev/null -w '%{http_code}' \
            --connect-timeout 10 --max-time 20 \
            https://dixis.gr/orders || true)

          echo "Orders page HTTP code: $ORDERS_CODE"

          # Expected: redirect to /auth/login (307/302) for unauthenticated, or 200 if public
          # MUST NOT be 404
          if [ "$ORDERS_CODE" = "307" ] || [ "$ORDERS_CODE" = "302" ] || [ "$ORDERS_CODE" = "200" ]; then
            echo "✅ PASS: Orders page behavior correct ($ORDERS_CODE)"
          else
            echo "❌ FAIL: Orders page returned $ORDERS_CODE (expected 307/302/200, NOT 404)"
            exit 1
          fi

      - name: Check PROD checkout API (MUST NOT return 500)
        run: |
          echo "=== Checking checkout API (transaction safety) ==="
          # POST to checkout with invalid/empty data
          # Expected: 400, 401, 422 (client errors) - NOT 500 (server error)
          # This guards against database transaction failures
          HTTP_CODE=$(curl -sS -o /dev/null -w '%{http_code}' \
            --connect-timeout 10 --max-time 20 \
            -X POST https://dixis.gr/api/v1/public/orders \
            -H "Content-Type: application/json" \
            -d '{}')

          echo "Checkout API HTTP code: $HTTP_CODE"

          # CRITICAL: MUST NOT be 500 (indicates DB transaction failure)
          if [ "$HTTP_CODE" = "500" ]; then
            echo "❌ CRITICAL FAIL: Checkout API returned 500 (database transaction error)"
            echo "This may indicate: Neon pooler issue, SELECT FOR UPDATE failure, or DB connection problem"
            exit 1
          fi

          # Expected client errors (400, 401, 422) are OK
          if [ "$HTTP_CODE" = "400" ] || [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "422" ]; then
            echo "✅ PASS: Checkout API responding correctly ($HTTP_CODE - validation/auth error as expected)"
          else
            echo "⚠️  WARNING: Checkout API returned unexpected code: $HTTP_CODE (expected 400/401/422 for invalid request)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "================================"
          echo "PROD Smoke Test Summary"
          echo "================================"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "All critical endpoints checked"
          echo "See workflow run for detailed results"
