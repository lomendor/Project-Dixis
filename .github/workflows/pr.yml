name: Pull Request Quality Gates

on:
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/**'

concurrency:
  group: pr-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  qa:
    name: Quality Assurance
    runs-on: ubuntu-latest
    timeout-minutes: 25
    continue-on-error: ${{ startsWith(github.head_ref, 'ci/') }}
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install and build contracts dependencies
        run: |
          if [ -d "../packages/contracts" ]; then
            cd ../packages/contracts
            npm ci
            npm run build
            cd ../../frontend
          else
            echo "No contracts directory found"
          fi

      - name: Run full QA suite
        run: |
          if [[ "${{ github.head_ref }}" == ci/* ]]; then
            echo "‚ö†Ô∏è Skipping QA suite on ci/* hotfix branch - allowing minimal quality checks"
            npm run qa:types || echo "Types check failed but continuing on ci/ branch"
            exit 0
          else
            npm run qa:all:ci
          fi

      - name: Build for bundle analysis
        run: npm run build

  test-smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    continue-on-error: true  # Pass 45: Advisory until E2E fully stabilized in Phase 2
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install and build contracts dependencies
        run: |
          if [ -d "../packages/contracts" ]; then
            cd ../packages/contracts
            npm ci
            npm run build
            cd ../../frontend
          else
            echo "No contracts directory found"
          fi

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start Test API server
        env:
          TEST_API_PORT: 8001
        run: |
          nohup npm run test:api > /tmp/test-api.log 2>&1 &
          npx --yes wait-on http://127.0.0.1:8001/health --timeout 120000
          echo "‚úÖ Test API server ready on port 8001"

      - name: Build and start Next.js app
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_BASE_URL: "http://127.0.0.1:8001"
          API_BASE_URL: "http://127.0.0.1:8001"
          NEXT_TELEMETRY_DISABLED: 1
        run: |
          npm run build
          nohup npm run start -- -p 3000 > /tmp/app.log 2>&1 &
          npx --yes wait-on http://127.0.0.1:3000 --timeout 120000
          echo "‚úÖ Next.js app ready on port 3000"

      - name: Run smoke tests (auth-probe only, skip @quarantine)
        continue-on-error: true  # Pass 45: Make smoke advisory until fully stable
        run: npx playwright test tests/e2e/auth-probe.spec.ts --reporter=list
        env:
          CI: true
          BASE_URL: http://127.0.0.1:3000
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:3000
          API_BASE_URL: http://127.0.0.1:8001
          NEXT_PUBLIC_API_BASE_URL: http://127.0.0.1:8001
          NEXT_PUBLIC_E2E: "true"
          NEXT_TELEMETRY_DISABLED: 1

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: frontend/test-results/
          retention-days: 3

      # Always upload artifacts for analysis
      - name: Upload Playwright report (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-playwright-report-always
          path: frontend/playwright-report/
          retention-days: 7

      - name: Upload test results (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results-always
          path: frontend/test-results/
          retention-days: 7

      - name: Cleanup CI processes
        if: always()
        working-directory: frontend
        run: |
          pkill -f "npm run test:api|npm run start|node.*test-api" || true
          echo "---- /tmp/test-api.log (tail) ----"
          tail -n 120 /tmp/test-api.log 2>/dev/null || echo "No test-api.log"
          echo "---- /tmp/app.log (tail) ----"
          tail -n 120 /tmp/app.log 2>/dev/null || echo "No app.log"

  danger:
    name: PR Hygiene Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    continue-on-error: true  # Pass 43: Make commitlint advisory until Phase 2
    permissions:
      contents: read
      pull-requests: write
      statuses: write
      checks: write
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run commitlint
        run: |
          # cleanup: temporary guards removed post-#243; QA tools remain via npm scripts
          npx commitlint --from HEAD~1 --to HEAD --verbose

      - name: Run Danger
        run: |
          # cleanup: temporary guards removed post-#243; QA tools remain via npm scripts
          npx danger ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # TODO: Re-enable Lighthouse CI after fixing configuration issue
  # lhci:
  #   name: Lighthouse CI
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: frontend

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #         cache-dependency-path: frontend/package-lock.json

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Build application
  #       run: npm run build

  #     - name: Run Lighthouse CI
  #       run: npm run lhci
  #       env:
  #         LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  #     - name: Generate Lighthouse summary
  #       if: always()
  #       run: |
  #         mkdir -p docs/reports/$(date +%Y-%m-%d)
  #         echo "# üöÄ Lighthouse CI Summary" > docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "**Date**: $(date)" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "**Commit**: ${{ github.sha }}" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "**PR**: #${{ github.event.number }}" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "## Performance Scores" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "- Homepage: ‚úÖ Performance audit completed" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "- Products: ‚úÖ Performance audit completed" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "- Cart: ‚úÖ Performance audit completed" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md
  #         echo "*See full Lighthouse reports in CI artifacts*" >> docs/reports/$(date +%Y-%m-%d)/LHCI-SUMMARY.md

  #     - name: Upload Lighthouse reports
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: lighthouse-reports
  #         path: frontend/.lighthouseci/
  #         retention-days: 7

  quality-gates:
    name: quality-gates
    runs-on: ubuntu-latest
    needs: [qa, test-smoke, danger]
    if: always()
    steps:
      - name: Check all gates passed
        run: |
          if [[ "${{ needs.qa.result }}" != "success" ]]; then
            echo "‚ùå Quality Assurance failed"
            exit 1
          fi
          # Smoke Tests and PR Hygiene are advisory (continue-on-error)
          # So we accept success, failure, or skipped
          echo "‚úÖ All quality gates evaluated (advisory gates may have warnings)"
          exit 0