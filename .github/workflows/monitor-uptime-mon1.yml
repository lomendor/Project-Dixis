name: MON1 uptime monitoring

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"
  push:
    paths:
      - ".github/workflows/monitor-uptime-mon1.yml"

jobs:
  mon1:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check healthz
        run: |
          set -euo pipefail
          code="$(curl -sS -o /dev/null -w "%{http_code}" https://dixis.gr/api/healthz)"
          echo "healthz=$code"
          test "$code" = "200"

      - name: Check products page
        run: |
          set -euo pipefail
          code="$(curl -sS -o /dev/null -w "%{http_code}" https://dixis.gr/products)"
          echo "products_page=$code"
          test "$code" = "200"

      - name: Check products API has data
        run: |
          set -euo pipefail
          body="$(curl -fsS https://dixis.gr/api/v1/public/products)"
          echo "$body" | head -c 220
          echo
          if command -v jq >/dev/null 2>&1; then
            count="$(echo "$body" | jq '.data | length' 2>/dev/null || echo 0)"
          else
            count="$(echo "$body" | grep -o '"id"' | wc -l | tr -d ' ')"
          fi
          echo "api_count=$count"
          test "$count" -ge 1
