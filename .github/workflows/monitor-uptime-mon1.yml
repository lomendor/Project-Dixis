name: MON1 - Production Uptime & Smoke Tests

on:
  schedule:
    # Run every 10 minutes
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  prod-endpoint-health:
    runs-on: ubuntu-latest
    steps:
      - name: Check /api/healthz (200 OK)
        run: |
          set -e
          URL="https://dixis.gr/api/healthz"
          echo "ğŸ” Checking $URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" --connect-timeout 10 --max-time 15)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… PASS: $URL returned $HTTP_CODE"
          else
            echo "âŒ FAIL: $URL returned $HTTP_CODE (expected 200)"
            exit 1
          fi

      - name: Check /products (200 OK)
        run: |
          set -e
          URL="https://dixis.gr/products"
          echo "ğŸ” Checking $URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" --connect-timeout 10 --max-time 15)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… PASS: $URL returned $HTTP_CODE"
          else
            echo "âŒ FAIL: $URL returned $HTTP_CODE (expected 200)"
            exit 1
          fi

      - name: Check /api/v1/public/products (200 + JSON data)
        run: |
          set -e
          URL="https://dixis.gr/api/v1/public/products"
          echo "ğŸ” Checking $URL"

          # Fetch response
          RESPONSE=$(curl -fsS "$URL" --connect-timeout 10 --max-time 15)

          # Validate HTTP 200 (curl -f ensures this)
          echo "âœ… HTTP 200 OK"

          # Parse JSON and check data length using Python
          python3 - <<PY
import json
import sys

response = '''$RESPONSE'''
data = json.loads(response)

# Check if 'data' key exists and has length > 0
if 'data' not in data:
    print("âŒ FAIL: Response missing 'data' key")
    sys.exit(1)

if not isinstance(data['data'], list):
    print("âŒ FAIL: 'data' is not a list")
    sys.exit(1)

if len(data['data']) == 0:
    print("âŒ FAIL: 'data' array is empty (length = 0)")
    sys.exit(1)

print(f"âœ… PASS: JSON data contains {len(data['data'])} products")
PY

      - name: All Checks Passed
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… MON1: All production endpoints healthy"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  â€¢ /api/healthz â†’ 200 OK"
          echo "  â€¢ /products â†’ 200 OK"
          echo "  â€¢ /api/v1/public/products â†’ 200 OK + JSON data"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
