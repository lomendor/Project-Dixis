name: Uptime Alert (on failure)
on:
  workflow_run:
    workflows: ["Uptime smoke"]
    types: [completed]

jobs:
  open-issue-on-failure:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Open or update P0 issue
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const title = `P0: Uptime failure on ${context.payload.workflow_run.head_branch || context.payload.workflow_run.display_title}`;
            const runUrl = context.payload.workflow_run.html_url;
            // Βρες υπάρχον ανοιχτό issue με ίδιο τίτλο
            const existing = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}"`
            });
            if (existing.data.items.length > 0) {
              const issue = existing.data.items[0];
              await github.rest.issues.createComment({
                owner, repo, issue_number: issue.number,
                body: `Uptime failed again.\nRun: ${runUrl}\nTimestamp: ${new Date().toISOString()}`
              });
            } else {
              const created = await github.rest.issues.create({
                owner, repo, title,
                body: `Uptime workflow failed.\nRun: ${runUrl}\nTimestamp: ${new Date().toISOString()}`,
                labels: ['P0-critical','infrastructure','needs-triage']
              });
            }
