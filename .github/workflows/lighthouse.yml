name: Lighthouse CI

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block the build
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Install contracts dependencies
        run: cd packages/contracts && npm ci
        
      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: http://localhost:3200

      - name: Install wait-on utility
        run: npm install -g wait-on

      - name: Install express for mock API
        run: npm install express

      - name: Start mock API and Next
        run: |
          cd frontend
          echo "Starting mock API..."
          MOCK_PORT=3200 npm run mock:api > mock-api.log 2>&1 &
          sleep 5
          echo "Mock API startup logs (first 20 lines):"
          head -20 mock-api.log || echo "No mock API logs yet"
          echo "Checking if mock API bound to port 3200..."
          lsof -i :3200 || echo "No process on port 3200"
          echo "Testing direct curl to mock API health endpoint..."
          curl -v http://localhost:3200/api/v1/health || echo "Curl failed"
          echo "Starting Next.js..."
          npm run start:ci &
        env:
          NEXT_PUBLIC_API_BASE_URL: http://localhost:3200
        
      - name: Wait for services
        run: |
          npx wait-on --timeout 90000 http://localhost:3200/api/v1/health
          npx wait-on --timeout 90000 http://localhost:3100
        
      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli
        
      - name: Lighthouse CI (use existing server)
        continue-on-error: ${{ github.event_name == 'pull_request' }}
        working-directory: frontend
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEXT_PUBLIC_API_BASE_URL: http://localhost:3200
          NODE_ENV: production
          CI: true
        run: |
          npx @lhci/cli autorun \
            --collect.url=http://localhost:3100 \
            --collect.startServerCommand="echo already started" \
            --assert.preset=lighthouse:recommended \
            --upload.target=filesystem \
            --upload.outputDir=.lighthouseci
        timeout-minutes: 10

      - name: Upload Lighthouse artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouseci
          path: frontend/.lighthouseci
