name: deploy-prod (dixis.gr)
on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why deploying?
        required: false
        default: manual
concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - uses: pnpm/action-setup@v4
        with: { version: 9 }

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Prepare VPS directory (fix permissions)
        run: |
          ssh "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" 'bash -c "
            cd /var/www/dixis-marketplace/frontend || exit 0
            # Remove immutable flags if any
            sudo chattr -R -i -a /var/www/dixis-marketplace/ 2>/dev/null || true
            # Fix ownership
            sudo chown -R deploy:deploy /var/www/dixis-marketplace/
            sudo chmod -R 775 /var/www/dixis-marketplace/
            echo \"Permissions fixed\"
          "'

      - name: Rsync frontend (exclude cache/node_modules)
        run: |
          rsync -rlpgoDz --omit-dir-times \
            --exclude node_modules --exclude .next \
            --exclude ".env" --exclude ".env.production" --exclude "prisma/.env" \
            ./frontend/ "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/dixis-marketplace/frontend/"

      - name: Remote deploy (install → migrate → build → pm2) with caches
        run: |
          # Pass DATABASE_URL directly via SSH environment
          ssh -o SendEnv=DATABASE_URL -o SendEnv=RUNTIME_DATABASE_URL "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" "DATABASE_URL='${{ secrets.DATABASE_URL_PROD }}' RUNTIME_DATABASE_URL='${{ secrets.RUNTIME_DATABASE_URL_PROD || secrets.DATABASE_URL_PROD }}' bash -lc '
            set -euo pipefail
            cd /var/www/dixis-marketplace/frontend

            # --- Remote caches
            REMOTE_CACHE_BASE=\$HOME/.cache/dixis
            PNPM_STORE_DIR=\$REMOTE_CACHE_BASE/pnpm-store
            NEXT_CACHE_DIR=\$REMOTE_CACHE_BASE/next
            mkdir -p \"\$PNPM_STORE_DIR\" \"\$NEXT_CACHE_DIR\"

            # --- DATABASE_URL guard
            [ -n \"\${DATABASE_URL:-}\" ] || { echo \"[ERR] DATABASE_URL empty\"; exit 1; }

            corepack enable >/dev/null 2>&1 || true
            corepack prepare pnpm@9.15.9 --activate
            export CI=true
            pnpm config set store-dir \"\$PNPM_STORE_DIR\"

            # Write env files
            rm -f prisma/.env
            printf \"DATABASE_URL=%s\\n\" \"\$DATABASE_URL\" > .env
            cp .env .env.production

            pnpm install --frozen-lockfile
            pnpm prisma migrate deploy || exit 21
            export NEXT_CACHE_DIR=\"\$NEXT_CACHE_DIR\"
            pnpm build

            # Kill any existing process on port 3000 and restart
            pkill -f \"next start\" || true
            sleep 2
            pm2 restart dixis-frontend --update-env || pm2 start npm --name dixis-frontend -- start
            curl -sI http://127.0.0.1:3000/api/healthz | head -n1 || true
          '"

      - name: Smoke
        run: |
          curl -sI https://dixis.gr/api/healthz | head -n1
          curl -sI https://dixis.gr | head -n1
