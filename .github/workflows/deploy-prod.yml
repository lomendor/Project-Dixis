name: deploy-prod (dixis.io)
on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why deploying?
        required: false
        default: manual
concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - uses: pnpm/action-setup@v4
        with: { version: 9 }

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Rsync frontend (exclude cache/node_modules)
        run: |
          rsync -az --delete \
            --exclude node_modules --exclude .next \
            --exclude ".env" --exclude ".env.production" --exclude "prisma/.env" \
            ./frontend/ "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/dixis/current/frontend/"

      - name: Remote deploy (install → migrate → build → pm2) with caches
        env:
          DBURL: ${{ secrets.DATABASE_URL_PROD }}
          RUNTIME_DBURL: ${{ secrets.RUNTIME_DATABASE_URL_PROD || secrets.DATABASE_URL_PROD }}
        run: |
          ssh "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" 'bash -lc "
            set -euo pipefail
            cd /var/www/dixis/current/frontend

            # --- Remote caches
            REMOTE_CACHE_BASE=\$HOME/.cache/dixis
            PNPM_STORE_DIR=\$REMOTE_CACHE_BASE/pnpm-store
            NEXT_CACHE_DIR=\$REMOTE_CACHE_BASE/next
            mkdir -p \"\$PNPM_STORE_DIR\" \"\$NEXT_CACHE_DIR\"

            # --- DATABASE_URL guard (raw/unpooled for migrations)
            if [ -n \"${DBURL:-}\" ]; then
              # Strip quotes from secret value (Prisma P1012 fix)
              DB_CLEAN=\"${DBURL}\"; DB_CLEAN=\"\${DB_CLEAN%\"\"}\"; DB_CLEAN=\"\${DB_CLEAN#\"\"}\"
              export DATABASE_URL=\"\$DB_CLEAN\"
            elif [ -f prisma/.env ]; then
              DB_LINE=\$(grep -E \"^DATABASE_URL=\" prisma/.env || true)
              DB_VAL=\"\${DB_LINE#DATABASE_URL=}\"; DB_VAL=\"\${DB_VAL%\"\"}\"; DB_VAL=\"\${DB_VAL#\"\"}\"
              export DATABASE_URL=\"\$DB_VAL\"
            fi
            [ -n \"\${DATABASE_URL:-}\" ] || { echo \"[ERR] DATABASE_URL empty (secret missing & no prisma/.env)\"; exit 1; }

            # --- RUNTIME_DBURL (can be pooled, fallback to raw)
            if [ -n \"${RUNTIME_DBURL:-}\" ]; then
              # Strip quotes from secret value
              RT_CLEAN=\"${RUNTIME_DBURL}\"; RT_CLEAN=\"\${RT_CLEAN%\"\"}\"; RT_CLEAN=\"\${RT_CLEAN#\"\"}\"
              export RUNTIME_DATABASE_URL=\"\$RT_CLEAN\"
            else
              export RUNTIME_DATABASE_URL=\"\$DATABASE_URL\"
            fi

            corepack enable >/dev/null 2>&1 || true
            corepack prepare pnpm@9.15.9 --activate
            export CI=true
            pnpm config set store-dir \"\$PNPM_STORE_DIR\"

            # Γράψε env αρχεία χωρίς quotes (Prisma P1012 fix)
            mkdir -p prisma
            install -m 600 -D /dev/null prisma/.env
            printf \"DATABASE_URL=%s\\n\" \"\$DATABASE_URL\" > prisma/.env
            printf \"DATABASE_URL=%s\\n\" \"\$RUNTIME_DATABASE_URL\" | tee .env > .env.production >/dev/null

            pnpm install --frozen-lockfile
            pnpm prisma migrate deploy || exit 21
            export NEXT_CACHE_DIR=\"\$NEXT_CACHE_DIR\"
            pnpm build

            pm2 restart dixis-frontend --update-env
            curl -sI http://127.0.0.1:3000/api/healthz | head -n1 || true
          "'

      - name: Smoke
        run: |
          curl -sI https://dixis.io/api/healthz | head -n1
          curl -sI https://dixis.io | head -n1
