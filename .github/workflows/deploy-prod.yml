name: deploy-prod (dixis.io)
on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why deploying?
        required: false
        default: manual
concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - uses: pnpm/action-setup@v4
        with: { version: 9 }

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Rsync (preserve env files)
        run: |
          rsync -az --delete \
            --exclude node_modules --exclude .next \
            --exclude ".env" --exclude ".env.production" --exclude "prisma/.env" \
            ./frontend/ "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/dixis/current/frontend/"

      - name: Remote deploy (install → migrate → build → pm2)
        run: |
          ssh "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" "DATABASE_URL='${{ secrets.DATABASE_URL_PROD }}' bash -lc '
            export DATABASE_URL
            set -euo pipefail
            cd /var/www/dixis/current/frontend

            # Αν το secret είναι κενό, πάρε τιμή από prisma/.env (αν υπάρχει)
            if [ -z \"${DATABASE_URL:-}\" ]; then
              if [ -f prisma/.env ]; then
                DB_LINE=$(grep -E \"^DATABASE_URL=\" prisma/.env || true)
                DB_VAL=\"${DB_LINE#DATABASE_URL=}\"
                DB_VAL=\"${DB_VAL%\"}\"; DB_VAL=\"${DB_VAL#\"}\"
                export DATABASE_URL=\"$DB_VAL\"
              fi
            fi
            [ -n \"${DATABASE_URL:-}\" ] || { echo \"[ERR] DATABASE_URL empty (secret missing & no prisma/.env).\"; exit 1; }

            corepack enable >/dev/null 2>&1 || true
            corepack prepare pnpm@9.15.9 --activate
            export CI=true

            # Γράψε env αρχεία για runtime (ο Prisma θα διαβάσει από process env)
            mkdir -p prisma
            install -m 600 -D /dev/null prisma/.env
            printf \"DATABASE_URL=\\\"%s\\\"\\n\" \"$DATABASE_URL\" > prisma/.env
            install -m 600 -D /dev/null .env
            install -m 600 -D /dev/null .env.production
            printf \"DATABASE_URL=\\\"%s\\\"\\n\" \"$DATABASE_URL\" | tee .env > .env.production >/dev/null

            pnpm install --frozen-lockfile
            pnpm prisma migrate deploy
            pnpm build

            pm2 restart dixis-frontend --update-env
            curl -sI http://127.0.0.1:3000/api/healthz | head -n1 || true
          '"

      - name: Smoke
        run: |
          curl -sI https://dixis.io/api/healthz | head -n1
          curl -sI https://dixis.io | head -n1
