name: VPS Diagnostic

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
          log-public-key: false

      - name: Add known host
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      - name: Remote diagnostic (ports, processes, nginx)
        run: |
          ssh "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" 'bash -c "
            set -euo pipefail
            echo \"=== SYSTEM INFO ===\"
            whoami
            hostname
            uptime
            echo \"\"

            echo \"=== NGINX STATUS ===\"
            systemctl status nginx --no-pager || true
            echo \"\"

            echo \"=== PM2 PROCESSES ===\"
            pm2 list || true
            echo \"\"

            echo \"=== LISTENING PORTS ===\"
            ss -lntp | grep -E \":(80|443|3000|8001)\b\" || true
            echo \"\"

            echo \"=== LOCAL HEALTH CHECKS ===\"
            curl -sS -o /dev/null -w \"local3000=%{http_code}\n\" http://127.0.0.1:3000/ || echo \"local3000=FAIL\"
            curl -sS -o /dev/null -w \"local8001=%{http_code}\n\" http://127.0.0.1:8001/ || echo \"local8001=FAIL\"
            curl -sS -o /dev/null -w \"healthz=%{http_code}\n\" https://dixis.gr/api/healthz || echo \"healthz=FAIL\"
            echo \"\"

            echo \"=== NGINX CONFIG (grep 8001) ===\"
            grep -R \"8001\" -n /etc/nginx 2>/dev/null | head -80 || echo \"No 8001 references in nginx config\"
            echo \"\"

            echo \"=== PM2 LOGS DIRECTORY ===\"
            ls -la /home/*/.pm2/logs 2>/dev/null | head -80 || echo \"No PM2 logs found\"
            ls -la /root/.pm2/logs 2>/dev/null | head -80 || echo \"No PM2 logs in /root\"
            echo \"\"

            echo \"=== BACKEND PROCESS CHECK ===\"
            ps aux | grep -E \"(php|artisan|serve)\" | grep -v grep || echo \"No PHP backend process found\"
            echo \"\"

            echo \"=== FRONTEND PM2 LOG (last 30 lines) ===\"
            LATEST_LOG=\$(ls -t /home/*/.pm2/logs/*error*.log 2>/dev/null | head -1) || true
            if [ -n \"\$LATEST_LOG\" ]; then
              echo \"Reading: \$LATEST_LOG\"
              tail -30 \"\$LATEST_LOG\" || true
            else
              echo \"No PM2 error logs found\"
            fi
          "'
