# MONITOR-01: Production Uptime Monitor
#
# Runs every 10 minutes to check production health.
# Creates GitHub Issue on failure for fast signal.
#
# Endpoints checked:
# - https://dixis.gr/api/healthz (backend Laravel health)
#
# No external services or secrets required - uses GITHUB_TOKEN.

name: uptime-monitor

on:
  schedule:
    # Every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip issue creation)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: uptime-monitor
  cancel-in-progress: true

jobs:
  check-production:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check production healthz
        id: healthz
        run: |
          echo "üîç Checking https://dixis.gr/api/healthz..."

          MAX_RETRIES=3
          RETRY_DELAY=5
          TIMEOUT=15

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt/$MAX_RETRIES"

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout $TIMEOUT \
              --max-time $TIMEOUT \
              https://dixis.gr/api/healthz) || HTTP_CODE="000"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Production healthy (HTTP $HTTP_CODE)"
              echo "status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "‚ö†Ô∏è HTTP $HTTP_CODE - retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done

          echo "‚ùå Production UNHEALTHY after $MAX_RETRIES attempts (last: HTTP $HTTP_CODE)"
          echo "status=unhealthy" >> $GITHUB_OUTPUT
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          exit 1

      - name: Create issue on failure
        if: failure() && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Production DOWN - healthz check failed';
            const body = `## Production Health Check Failed

            **Time**: ${new Date().toISOString()}
            **Endpoint**: https://dixis.gr/api/healthz
            **Last HTTP Code**: ${{ steps.healthz.outputs.http_code || 'unknown' }}
            **Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            ## First Steps
            1. Check if site is accessible: https://dixis.gr
            2. SSH to VPS and check services: \`systemctl status dixis-backend dixis-frontend-launcher\`
            3. Check logs: \`journalctl -u dixis-backend -n 50\`
            4. See runbook: docs/OPS/MONITORING.md

            ---
            *Auto-created by uptime-monitor workflow*`;

            // Check for existing open issue to avoid duplicates
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'production-down',
              per_page: 1
            });

            if (issues.length > 0) {
              console.log(`Existing issue #${issues[0].number} already open, adding comment`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `‚è∞ Health check failed again at ${new Date().toISOString()}\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
            } else {
              console.log('Creating new issue');
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['production-down', 'urgent']
              });
            }
