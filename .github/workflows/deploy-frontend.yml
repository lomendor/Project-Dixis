name: Deploy Frontend (VPS)
on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: SSH Deploy (build & restart via PM2)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            # Try to get APP_DIR from PM2, fallback to known path
            APP_DIR="$(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="dixis-frontend") | .pm2_env.pm_cwd' 2>/dev/null || echo '')"
            if [ -z "$APP_DIR" ] || [ ! -d "$APP_DIR" ]; then
              APP_DIR="/var/www/dixis/current/frontend"
              echo "→ PM2 process not found, using fallback: $APP_DIR"
            fi
            [ -d "$APP_DIR" ] || { echo "APP_DIR $APP_DIR not found"; exit 1; }
            cd "$APP_DIR"

            # Fix git safe.directory for different user ownership
            REPO_ROOT="$(cd .. && pwd)"
            git config --global --add safe.directory "$REPO_ROOT"
            git config --global --add safe.directory "$APP_DIR"

            echo "→ Sync main"
            git fetch origin
            git reset --hard origin/main

            echo "→ Ensure env for demo build (NO secrets leak)"
            export NEXT_PUBLIC_BASE_URL="https://dixis.gr"
            export PRODUCTS_MODE="demo"

            echo "→ Build (with memory limit for low-RAM VPS)"
            rm -rf node_modules .next
            pnpm install --frozen-lockfile
            NODE_OPTIONS="--max-old-space-size=1536" pnpm build

            echo "→ Restart (or start if not exists)"
            if pm2 describe dixis-frontend > /dev/null 2>&1; then
              pm2 restart dixis-frontend --update-env
            else
              echo "→ PM2 process not found, starting fresh..."
              pm2 start npm --name "dixis-frontend" -- start
              pm2 save
            fi

            echo "→ Wait for startup"
            sleep 15

            echo "→ Smoke"
            curl -sI http://127.0.0.1:3000 | head -1
            curl -s https://dixis.gr/api/healthz | head -1
