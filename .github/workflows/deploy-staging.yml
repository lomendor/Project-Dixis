name: Deploy Staging

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/deploy-staging.yml'

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  deploy:
    name: staging-deploy
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: staging
    env:
      STAGING_HOST: ${{ secrets.STAGING_HOST }}
      STAGING_USER: ${{ secrets.STAGING_USER }}
      STAGING_PATH: ${{ secrets.STAGING_PATH }}

    steps:
      - uses: actions/checkout@v4

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts

      - name: Preflight
        run: |
          echo "ðŸŽ¯ Deployment target:"
          echo "  Host: $STAGING_HOST"
          echo "  User: $STAGING_USER"
          echo "  Path: $STAGING_PATH"

      - name: Create remote folders
        run: |
          ssh -i ~/.ssh/id_ed25519 ${STAGING_USER}@${STAGING_HOST} \
            "mkdir -p ${STAGING_PATH}/current ${STAGING_PATH}/public"

      - name: Deploy (rsync)
        run: |
          rsync -avz --delete \
            --exclude ".git" \
            --exclude "node_modules" \
            --exclude "vendor" \
            --exclude ".env" \
            --exclude "*.log" \
            ./ ${STAGING_USER}@${STAGING_HOST}:${STAGING_PATH}/current/

      - name: Health check (HTTP via IP)
        run: |
          echo "ðŸ©º Health check..."
          curl -fsS -H "Host: staging.dixis.gr" "http://${STAGING_HOST}/api/healthz"
          echo "âœ… Staging deployment successful!"
