name: Deploy Staging

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/deploy-staging.yml'

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  deploy:
    name: staging-deploy
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: staging
    env:
      STAGING_HOST: ${{ secrets.STAGING_HOST }}
      STAGING_USER: ${{ secrets.STAGING_USER }}
      STAGING_PATH: ${{ secrets.STAGING_PATH }}

    steps:
      - uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: frontend

      - name: Build Next.js (standalone)
        run: pnpm build
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}

      - name: Verify build artifacts
        run: |
          test -d frontend/.next/standalone || { echo "‚ùå Missing .next/standalone"; exit 1; }
          test -d frontend/.next/static || { echo "‚ùå Missing .next/static"; exit 1; }
          test -d frontend/public || { echo "‚ùå Missing public/"; exit 1; }
          echo "‚úÖ Build artifacts verified"

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          KNOWN_HOSTS: ${{ secrets.KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Use pre-configured known_hosts if available, fallback to ssh-keyscan
          if [ -n "$KNOWN_HOSTS" ]; then
            echo "$KNOWN_HOSTS" > ~/.ssh/known_hosts
            echo "‚úÖ Using pre-configured known_hosts"
          else
            echo "‚ö†Ô∏è  KNOWN_HOSTS secret not set, trying ssh-keyscan..."
            ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts || {
              echo "‚ùå ssh-keyscan failed - ensure STAGING_HOST is reachable"
              exit 1
            }
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Preflight
        run: |
          echo "üéØ Deployment target:"
          echo "  Host: $STAGING_HOST"
          echo "  User: $STAGING_USER"
          echo "  Path: $STAGING_PATH"

          # Validate STAGING_HOST format (no https:// prefix, no paths)
          if [[ "$STAGING_HOST" =~ ^https?:// ]] || [[ "$STAGING_HOST" =~ / ]]; then
            echo "‚ùå STAGING_HOST must be clean IP or DNS (found: $STAGING_HOST)"
            exit 1
          fi

          # Test DNS resolution
          echo "üîç Testing DNS resolution..."
          if ! getent hosts "$STAGING_HOST" > /dev/null 2>&1; then
            echo "‚ùå Cannot resolve STAGING_HOST: $STAGING_HOST"
            exit 1
          fi
          echo "‚úÖ DNS resolution successful"

          # Test SSH connectivity
          echo "üîç Testing SSH connectivity (port 22)..."
          if ! nc -vz -w 5 "$STAGING_HOST" 22 2>&1 | grep -q 'succeeded\|open'; then
            echo "‚ùå Cannot connect to $STAGING_HOST:22"
            exit 1
          fi
          echo "‚úÖ SSH port reachable"

      - name: Create remote folders
        run: |
          ssh -i ~/.ssh/id_ed25519 ${STAGING_USER}@${STAGING_HOST} \
            "mkdir -p ${STAGING_PATH}/.next/standalone ${STAGING_PATH}/.next/static ${STAGING_PATH}/public"

      - name: Deploy artifacts (rsync)
        run: |
          echo "üì¶ Deploying standalone server..."
          rsync -avz --delete \
            frontend/.next/standalone/ \
            ${STAGING_USER}@${STAGING_HOST}:${STAGING_PATH}/.next/standalone/

          echo "üì¶ Deploying static assets..."
          rsync -avz --delete \
            frontend/.next/static/ \
            ${STAGING_USER}@${STAGING_HOST}:${STAGING_PATH}/.next/static/

          echo "üì¶ Deploying public files..."
          rsync -avz --delete \
            frontend/public/ \
            ${STAGING_USER}@${STAGING_HOST}:${STAGING_PATH}/public/

          echo "‚úÖ Artifacts deployed"

      - name: Restart PM2 (idempotent)
        run: |
          ssh -i ~/.ssh/id_ed25519 ${STAGING_USER}@${STAGING_HOST} bash <<REMOTE_SCRIPT
          set -euo pipefail

          # Discover PORT from nginx config
          PORT=\$(sudo nginx -T 2>/dev/null | grep -A 10 'server_name staging.dixis.io' | grep 'proxy_pass' | grep -oP '127.0.0.1:\K\d+' || echo "3001")
          echo "üîç Discovered PORT: \$PORT"

          # Idempotent restart
          if pm2 list | grep -q dixis-staging; then
            echo "üîÑ Reloading existing process..."
            pm2 reload dixis-staging --update-env
          else
            echo "üöÄ Starting new process on port \$PORT..."
            cd ${STAGING_PATH}/.next/standalone
            PORT=\$PORT NODE_ENV=production DIXIS_ENV=staging pm2 start server.js --name dixis-staging --time
            pm2 save
          fi

          echo "‚úÖ PM2 status:"
          pm2 status
          REMOTE_SCRIPT

      - name: Health check
        run: |
          echo "ü©∫ Staging health check..."
          sleep 3
          ssh -i ~/.ssh/id_ed25519 ${STAGING_USER}@${STAGING_HOST} bash <<HEALTH_CHECK
          set -euo pipefail

          # Discover PORT from PM2
          PORT=\$(pm2 jlist | grep -A 5 'dixis-staging' | grep -oP '"PORT":\s*"\K\d+' || echo "3001")
          echo "üîç Health check on port \$PORT"

          # Call healthz endpoint
          RESPONSE=\$(curl -fsS http://localhost:\$PORT/api/healthz 2>&1)
          echo "üìã Response: \$RESPONSE"

          # Validate JSON response contains "status":"ok"
          if echo "\$RESPONSE" | grep -q '"status":"ok"'; then
            echo "‚úÖ Health check PASSED"
            exit 0
          else
            echo "‚ùå Health check FAILED - invalid response"
            exit 1
          fi
          HEALTH_CHECK
          echo "‚úÖ Staging deployment successful!"
