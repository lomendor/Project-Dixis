name: Deploy Staging

on:
  workflow_dispatch:

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  deploy:
    name: staging-deploy
    runs-on: ubuntu-latest
    environment: staging
    env:
      STAGING_HOST: ${{ secrets.STAGING_HOST }}
      STAGING_USER: ${{ secrets.STAGING_USER }}
      STAGING_PATH: ${{ secrets.STAGING_PATH }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      BASE_URL: ${{ vars.STAGING_BASE_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Preflight secrets
        id: preflight
        shell: bash
        run: |
          set -e
          MISSING=0
          for k in STAGING_HOST STAGING_USER STAGING_PATH SSH_PRIVATE_KEY; do
            if [ -z "${!k:-}" ]; then
              echo "â— Missing secret: $k"
              MISSING=1
            fi
          done
          if [ $MISSING -eq 1 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Mark SKIPPED (no secrets yet)
        if: ${{ steps.preflight.outputs.skip == 'true' }}
        run: |
          echo "â„¹ï¸ Staging deploy skipped: define repo environment 'staging' secrets:"
          echo "   â€¢ STAGING_HOST  (e.g. 203.0.113.10)"
          echo "   â€¢ STAGING_USER  (e.g. deploy)"
          echo "   â€¢ STAGING_PATH  (e.g. /var/www/staging.dixis.io)"
          echo "   â€¢ SSH_PRIVATE_KEY (PEM private key for the deploy user)"

      - name: Setup SSH
        if: ${{ steps.preflight.outputs.skip != 'true' }}
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        if: ${{ steps.preflight.outputs.skip != 'true' }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts

      - name: SSH reachability check
        if: ${{ steps.preflight.outputs.skip != 'true' }}
        run: |
          ssh -o BatchMode=yes "${STAGING_USER}@${STAGING_HOST}" "echo 'âœ… SSH OK on ' \$(hostname)"

      # Placeholder deploy (no-op). We'll replace with real rsync/Docker on next pass.
      - name: Placeholder deploy step
        if: ${{ steps.preflight.outputs.skip != 'true' }}
        run: |
          echo "ðŸš€ (placeholder) would deploy repo to $STAGING_USER@$STAGING_HOST:$STAGING_PATH"
          echo "Next pass will rsync/build/restart services."
